<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"pacoblack.github.io","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":true,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="先来看看Flutter的大体构造">
<meta property="og:type" content="article">
<meta property="og:title" content="flutter框架总览">
<meta property="og:url" content="https://pacoblack.github.io/2019/12/04/flutter%E6%A1%86%E6%9E%B6%E6%80%BB%E8%A7%88/index.html">
<meta property="og:site_name" content="我爱学习">
<meta property="og:description" content="先来看看Flutter的大体构造">
<meta property="og:locale">
<meta property="og:image" content="https://pacoblack.github.io/2019/12/04/flutter%E6%A1%86%E6%9E%B6%E6%80%BB%E8%A7%88/flutter1.jpg">
<meta property="og:image" content="https://pacoblack.github.io/2019/12/04/flutter%E6%A1%86%E6%9E%B6%E6%80%BB%E8%A7%88/flutter2.jpg">
<meta property="og:image" content="https://pacoblack.github.io/2019/12/04/flutter%E6%A1%86%E6%9E%B6%E6%80%BB%E8%A7%88/flutter4.jpg">
<meta property="og:image" content="https://pacoblack.github.io/2019/12/04/flutter%E6%A1%86%E6%9E%B6%E6%80%BB%E8%A7%88/flutter3.jpg">
<meta property="og:image" content="https://pacoblack.github.io/2019/12/04/flutter%E6%A1%86%E6%9E%B6%E6%80%BB%E8%A7%88/flutter5.jpg">
<meta property="og:image" content="https://pacoblack.github.io/2019/12/04/flutter%E6%A1%86%E6%9E%B6%E6%80%BB%E8%A7%88/flutter6.jpg">
<meta property="og:image" content="https://pacoblack.github.io/2019/12/04/flutter%E6%A1%86%E6%9E%B6%E6%80%BB%E8%A7%88/isolate.jpg">
<meta property="og:image" content="https://pacoblack.github.io/2019/12/04/flutter%E6%A1%86%E6%9E%B6%E6%80%BB%E8%A7%88/sendMsg.jpg">
<meta property="og:image" content="https://pacoblack.github.io/2019/12/04/flutter%E6%A1%86%E6%9E%B6%E6%80%BB%E8%A7%88/flutter7.jpg">
<meta property="og:image" content="https://pacoblack.github.io/2019/12/04/flutter%E6%A1%86%E6%9E%B6%E6%80%BB%E8%A7%88/flutter8.jpg">
<meta property="og:image" content="https://pacoblack.github.io/2019/12/04/flutter%E6%A1%86%E6%9E%B6%E6%80%BB%E8%A7%88/flutter9.jpg">
<meta property="og:image" content="https://pacoblack.github.io/2019/12/04/flutter%E6%A1%86%E6%9E%B6%E6%80%BB%E8%A7%88/flutter10.jpg">
<meta property="article:published_time" content="2019-12-04T11:08:48.000Z">
<meta property="article:modified_time" content="2021-10-29T10:56:45.345Z">
<meta property="article:author" content="pacoblack">
<meta property="article:tag" content="Flutter">
<meta property="article:tag" content="深入理解">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://pacoblack.github.io/2019/12/04/flutter%E6%A1%86%E6%9E%B6%E6%80%BB%E8%A7%88/flutter1.jpg">

<link rel="canonical" href="https://pacoblack.github.io/2019/12/04/flutter%E6%A1%86%E6%9E%B6%E6%80%BB%E8%A7%88/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-Hans'
  };
</script>

  <title>flutter框架总览 | 我爱学习</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">我爱学习</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">这只是一场演习</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="主页 fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="标签 fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="分类 fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="归档 fa-fw"></i>Archives</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="关于 fa-fw"></i>About</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="https://pacoblack.github.io/2019/12/04/flutter%E6%A1%86%E6%9E%B6%E6%80%BB%E8%A7%88/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar1.jpeg">
      <meta itemprop="name" content="pacoblack">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="我爱学习">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          flutter框架总览
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-12-04 19:08:48" itemprop="dateCreated datePublished" datetime="2019-12-04T19:08:48+08:00">2019-12-04</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-10-29 18:56:45" itemprop="dateModified" datetime="2021-10-29T18:56:45+08:00">2021-10-29</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/flutter/" itemprop="url" rel="index"><span itemprop="name">Flutter</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/flutter/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3/" itemprop="url" rel="index"><span itemprop="name">深入理解</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>先来看看Flutter的大体构造</p>
<span id="more"></span>
<h1 id="引擎"><a href="#引擎" class="headerlink" title="引擎"></a>引擎</h1><p><img src="/2019/12/04/flutter%E6%A1%86%E6%9E%B6%E6%80%BB%E8%A7%88/flutter1.jpg" alt="对比"></p>
<p>安卓原生框架 APP 调到大家熟悉的安卓 Framework，Framework 再调到 Skia，Skia 再最终渲染调到 GPU。对于 Flutter 中间调的是一个 Dart Framework，再调到 Skia，用 Flutter 平台和原生很接近</p>
<p><img src="/2019/12/04/flutter%E6%A1%86%E6%9E%B6%E6%80%BB%E8%A7%88/flutter2.jpg" alt="Engine"></p>
<p>上面是用 Dart 写的 APP，下面有 DartFramework，Framework 里有安卓和 iOS 的主体，里面有很多动画等等。再往下会调到引擎，引擎里有消息、PlatformChannel、Dart VM 等，引擎层再到平台。</p>
<blockquote>
<p>一个FlutterView对应一个FlutterEngine实例；<br>一个FlutterEngine实例对应一个Dart Isolate实例；<br>同一个进程只有且仅有一个Dart VM虚拟机；<br>一个Dart VM上会存在多个Dart Isolate实例，Isolate是dart代码的执行环境；</p>
</blockquote>
<h1 id="编译框架"><a href="#编译框架" class="headerlink" title="编译框架"></a>编译框架</h1><p><img src="/2019/12/04/flutter%E6%A1%86%E6%9E%B6%E6%80%BB%E8%A7%88/flutter4.jpg" alt="flutter编译结构"></p>
<p>Dart 代码最上用前端编译器编译，下面左边绿色的是安卓，右边蓝色的是 iOS，根据不同的平台会产生不同的产物。</p>
<h1 id="进程框架"><a href="#进程框架" class="headerlink" title="进程框架"></a>进程框架</h1><p><img src="/2019/12/04/flutter%E6%A1%86%E6%9E%B6%E6%80%BB%E8%A7%88/flutter3.jpg" alt="启动框架"></p>
<p>Flutter 有 Flutter 的 Application 和 Flutter 的 Activity。在 Flutter Application 中就会把 Dart 写的代码生成一个产物，把它加载起来，我们的 Flutter Activity 过程中会拉起我们的引擎。</p>
<p>引擎中，Flutter 四个核心线程：平台线程、UI 线程、GPU 线程、IO 线程，它们各有分工：</p>
<ul>
<li>平台线程，对于安卓和 iOS 来说就是常说的主线程，<br>一般来说，一个Flutter应用启动的时候会创建一个Engine实例，Engine创建的时候会创建一个线程供 Platform Runner 使用。跟Flutter Engine的所有交互（接口调用）必须在 Platform Thread 进行，否则可能导致无法预期的异常。这跟iOS UI相关的操作都必须在主线程进行相类似。需要注意的是在Flutter Engine中有很多模块都是非线程安全的。规则很简单，对于Flutter Engine的接口调用都需保证在Platform Thread进行。阻塞 Platform Thread 不会直接导致Flutter应用的卡顿（跟iOS android主线程不同）。尽管如此，也不建议在这个Runner执行繁重的操作，长时间卡住Platform Thread应用有可能会被系统Watchdog强杀。<br>实际上我们可以同时启动多个Engine实例，每个Engine对应一个Platform Runxner，每个Runner跑在各自的线程里。</li>
<li>UI 线程，面对安卓本身的主线程，就是一个独立的线程；UI Task Runner用于执行Dart root isolate代码<br>Root isolate比较特殊，它绑定了不少Flutter需要的函数方法，以便进行渲染相关操作。对于每一帧，引擎要做的事情有：<ol>
<li>Root isolate通知Flutter Engine有帧需要渲染。</li>
<li>Flutter Engine通知平台，需要在下一个vsync的时候得到通知。</li>
<li>平台等待下一个vsync</li>
<li>对创建的对象和Widgets进行Layout并生成一个Layer Tree，这个Tree马上被提交给Flutter Engine。当前阶段没有进行任何光栅化，这个步骤仅是生成了对需要绘制内容的描述。</li>
<li>创建或者更新Tree，这个Tree包含了用于屏幕上显示Widgets的语义信息。这个东西主要用于平台相关的辅助Accessibility元素的配置和渲染。<br>除了渲染相关逻辑之外Root Isolate还是处理来自Native Plugins的消息，Timers，Microtasks和异步IO等操作。Root Isolate负责创建管理的Layer Tree最终决定绘制到屏幕上的内容。因此这个线程的过载会直接导致卡顿掉帧。</li>
</ol>
</li>
<li>GPU 线程，指的是跑在 GPU 上的线程，它做的主要是 Skia 相关工作。<br>UI Task Runner创建的Layer Tree是跨平台的，它不关心到底由谁来完成绘制。GPU Task Runner负责将Layer Tree提供的信息转化为平台可执行的GPU指令。GPU Task Runner同时负责绘制所需要的GPU资源的管理。资源主要包括平台Framebuffer，Surface，Texture和Buffers等。<br>一般来说UI Runner和GPU Runner跑在不同的线程。GPU Runner会根据目前帧执行的进度去向UI Runner要求下一帧的数据，在任务繁重的时候可能会告诉UI Runner延迟任务。这种调度机制确保GPU Runner不至于过载，同时也避免了UI Runner不必要的消耗。<br>建议为每一个Engine实例都新建一个专用的GPU Runner线程。</li>
<li>IO 线程，比如图片解码、编解码，主要做 IO 相关的工作。<br>Platform Runner过载可能导致系统WatchDog强杀，UI和GPU Runner过载则可能导致Flutter应用的卡顿。但是GPU线程的一些必要操作，例如IO，放到哪里执行呢？答案正是IO Runner。<br>IO Runner的主要功能是从图片存储（比如磁盘）中读取压缩的图片格式，将图片数据进行处理为GPU Runner的渲染做好准备。IO Runner首先要读取压缩的图片二进制数据（比如PNG，JPEG），将其解压转换成GPU能够处理的格式然后将数据上传到GPU。<br>获取诸如ui.Image这样的资源只有通过async call去调用，当调用发生的时候Flutter Framework告诉IO Runner进行加载的异步操作。<br>IO Runner直接决定了图片和其它一些资源加载的延迟间接影响性能。所以建议为IO Runner创建一个专用的线程。</li>
</ul>
<h1 id="线程框架"><a href="#线程框架" class="headerlink" title="线程框架"></a>线程框架</h1><p><img src="/2019/12/04/flutter%E6%A1%86%E6%9E%B6%E6%80%BB%E8%A7%88/flutter5.jpg" alt="线程通信"></p>
<p>以安卓为例，Flutter 依然有一个 Looper 线程，对于主线程复用了原来的 Native 的，对于另外三个线程创建的独立的 Looper，不同的是它有两个消息队列，依然是发送消息的方式，通过 Task Runner 就好比安卓的 Handler，通过 PostTask 就好比把一个消息放在一个消息队列里去。同样在 Dart 里经常用 Furture 和异步的方法，核心还是用 Task Runner 发一个消息。</p>
<h1 id="Dart虚拟机"><a href="#Dart虚拟机" class="headerlink" title="Dart虚拟机"></a>Dart虚拟机</h1><p><img src="/2019/12/04/flutter%E6%A1%86%E6%9E%B6%E6%80%BB%E8%A7%88/flutter6.jpg" alt="Dart虚拟机"></p>
<p>同一个进程里可以有很多 Isolate，两个 Isolate 的堆是不能共享的，但它们也可以交互。在 Dart 虚拟机里面也有一个特殊 Isolate，是运行在 UI 线程中，和 Root Isolate 是运行在一个线程的。当两个 Isolate 要通信，会找一个共同的可访问的内存。</p>
<p><img src="/2019/12/04/flutter%E6%A1%86%E6%9E%B6%E6%80%BB%E8%A7%88/isolate.jpg" alt="isolate"></p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//在父Isolate中调用</span></span><br><span class="line">Isolate isolate;</span><br><span class="line">start() <span class="keyword">async</span> &#123;</span><br><span class="line">  ReceivePort receivePort = ReceivePort();</span><br><span class="line">  <span class="comment">//创建子Isolate对象</span></span><br><span class="line">  isolate = <span class="keyword">await</span> Isolate.spawn(getMsg, receivePort.sendPort);</span><br><span class="line">  <span class="comment">//监听子Isolate的返回数据</span></span><br><span class="line">  receivePort.listen((data) &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;data：<span class="subst">$data</span>&#x27;</span>);</span><br><span class="line">    receivePort.close();</span><br><span class="line">    <span class="comment">//关闭Isolate对象</span></span><br><span class="line">    isolate?.kill(priority: Isolate.immediate);</span><br><span class="line">    isolate = <span class="keyword">null</span>;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//子Isolate对象的入口函数，可以在该函数中做耗时操作</span></span><br><span class="line">getMsg(sendPort) =&gt; sendPort.send(<span class="string">&quot;hello&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>创建Isolate时会将其中的MessageHandler对象添加到一个全局的map，（在Dart VM初始化的时候创建，每个元素都是一个Entry对象，在Entry中，有一个MessageHandler对象，一个端口号及该端口的状态。），接着创建 ReceivePort 对象，ReceivePort对应着Dart SDK中的_RawReceivePortImpl对象，SendPort对应着Dart SDK中的_SendPortImpl对象。当ReceivePort创建成功后，就可以通过调用_SendPortImpl的send函数来发送消息。send 发送消息时，将消息加入到了目标Isolate的MessageHandler中，<br>在PostMessage中主要是做了以下操作</p>
<ol>
<li>根据消息级别将消息加入到不同的队列中。主要有OOB消息及普通消息两个级别，OOB消息在队列oob_queue_中，普通消息在队列queue_中。OOB消息级别高于普通消息，会立即处理。</li>
<li>将一个消息处理任务MessageHandlerTask加入到线程中。</li>
</ol>
<p>普通消息的处理</p>
<ol>
<li>首先调用Dart SDK中_RawReceivePortImpl对象的_lookupHandler函数，返回一个在创建_RawReceivePortImpl对象时注册的一个自定义函数。</li>
<li>调用Dart SDK中_RawReceivePortImpl对象的_handleMessage函数并传入1中返回的自定义函数，通过该自定义函数将消息分发出去</li>
</ol>
<p>双向通信也很简单，在父Isolate中创建一个端口，并在创建子Isolate时，将这个端口传递给子Isolate。然后在子Isolate调用其入口函数时也创建一个新端口，并通过父Isolate传递过来的端口把子Isolate创建的端口传递给父Isolate，这样父Isolate与子Isolate分别拥有对方的一个端口号，从而实现了通信</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//当前函数在父Isolate中</span></span><br><span class="line">Future&lt;<span class="built_in">dynamic</span>&gt; asyncFactoriali(n) <span class="keyword">async</span> &#123;</span><br><span class="line">  <span class="comment">//父Isolate对应的ReceivePort对象</span></span><br><span class="line">  <span class="keyword">final</span> response = ReceivePort();</span><br><span class="line">  <span class="comment">//创建一个子Isolate对象</span></span><br><span class="line">  <span class="keyword">await</span> Isolate.spawn(_isolate, response.sendPort);</span><br><span class="line">  <span class="keyword">final</span> sendPort = <span class="keyword">await</span> response.first <span class="keyword">as</span> SendPort;</span><br><span class="line">  <span class="keyword">final</span> answer = ReceivePort();</span><br><span class="line">  <span class="comment">//给子Isolate发送数据</span></span><br><span class="line">  sendPort.send([n, answer.sendPort]);</span><br><span class="line">  <span class="keyword">return</span> answer.first;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//子Isolate的入口函数，可以在该函数中做耗时操作</span></span><br><span class="line"><span class="comment">//_isolate必须是顶级函数（不能存在任何类中）或者是静态函数（可以存在类中）</span></span><br><span class="line">_isolate(SendPort initialReplyTo) <span class="keyword">async</span> &#123;</span><br><span class="line">  <span class="comment">//子Isolate对应的ReceivePort对象</span></span><br><span class="line">  <span class="keyword">final</span> port = ReceivePort();</span><br><span class="line">  initialReplyTo.send(port.sendPort);</span><br><span class="line">  <span class="keyword">final</span> message = <span class="keyword">await</span> port.first <span class="keyword">as</span> <span class="built_in">List</span>;</span><br><span class="line">  <span class="keyword">final</span> data = message[<span class="number">0</span>] <span class="keyword">as</span> <span class="built_in">int</span>;</span><br><span class="line">  <span class="keyword">final</span> send = message[<span class="number">1</span>] <span class="keyword">as</span> SendPort;</span><br><span class="line">  <span class="comment">//给父Isolate的返回数据</span></span><br><span class="line">  send.send(syncFactorial(data));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//运行代码</span></span><br><span class="line">start() <span class="keyword">async</span> &#123;</span><br><span class="line">  <span class="built_in">print</span>(<span class="string">&quot;计算结果：<span class="subst">$&#123;await asyncFactoriali(<span class="number">4</span>)&#125;</span>&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">start();</span><br></pre></td></tr></table></figure>

<p><img src="/2019/12/04/flutter%E6%A1%86%E6%9E%B6%E6%80%BB%E8%A7%88/sendMsg.jpg" alt="过程图"><br><a target="_blank" rel="noopener" href="https://juejin.im/post/5e149a7df265da5d3b32e167#heading-6">原文</a></p>
<p>Isolate1 和 Isolate2 通信是在 Isolate2 里创一个 ReceivePort，在 Isolate1 中调用其对应的 SendPort 的 send 方法，在引擎 PortMap 里面有映射表，每一个 port 端口对应一个相应 Isolate 的 MessageHandler，该 Handler 里面有两个队列，一个是普通的消息队列，一个是 OOB 高优先级消息，根据优先级把它放到相应消息队列。再把这个 <strong>事件封装成一个 MessageTask，抛到另外一个 Isolate 里去</strong>，我们一般创建一个 Isolate，它里面是一个 worker 线程，worker 线程放入一个新的 Task，它就会最终去执行这个 Task</p>
<h1 id="Widget-结构"><a href="#Widget-结构" class="headerlink" title="Widget 结构"></a>Widget 结构</h1><p><img src="/2019/12/04/flutter%E6%A1%86%E6%9E%B6%E6%80%BB%E8%A7%88/flutter7.jpg" alt="Widget"></p>
<p>Widget 可以是一行文本、一张图片、一个颜色，所有都是 Widget。最大有两类，一个是无状态的 Widget，一个是有状态的。无状态顾名思义是一类 StatelessWidget，一旦创建状态是不可改变的；第二类 StatefulWidget 是状态可以改变的<br><img src="/2019/12/04/flutter%E6%A1%86%E6%9E%B6%E6%80%BB%E8%A7%88/flutter8.jpg" alt="Widget渲染"></p>
<p>对应 Widget 创建 Widget 树，它是 Element 的配置，如果两个 Widget 之间做了变化它会做差分，比较一下到底哪部分做了变化，只把变化更新到 Element 里去，以最小粒度做更新。到了 Element 里构建渲染过程中会创建 Render 对象，创建渲染的过程。</p>
<p><img src="/2019/12/04/flutter%E6%A1%86%E6%9E%B6%E6%80%BB%E8%A7%88/flutter9.jpg" alt="渲染原理"><br>渲染来了一个信号，<strong>UI 线程</strong> 更新动画，动画完了会生成 Render，再往下布局、绘制大小等工作，最终生成一个 Layer Tree。</p>
<p>接着会到 <strong>GPU 线程</strong> 调用 Skia 做渲染</p>
<h1 id="原生通信"><a href="#原生通信" class="headerlink" title="原生通信"></a>原生通信</h1><p><img src="/2019/12/04/flutter%E6%A1%86%E6%9E%B6%E6%80%BB%E8%A7%88/flutter10.jpg" alt="Channel"></p>
<p>橙色部分代码，写相应平台安卓或者 iOS 定制代码，中间有一套封装好的机制，通过 Dart 代码直接可以调到安卓或者 iOS 代码，且这个过程是异步的。</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>Flutter 是会根据ios和安卓编译生成不同的执行文件，android是生成一个flutter.jar。<br>以安卓为例，flutter的启动也是依赖原生的application来启动，并同时生成四个线程，四个线程的通信与Android原生的Handler通信类似，也是发送消息，区别在于另外三个线程公用两个队列，另外进程间通信与原生不同，不能直接通信，需要一个共享内存，这个共享内存位于flutter 引擎，记录不同线程的 sendPort 和 receivePort，每个port对应一个 MessageHandler，发送的消息会封装成一个MessageTask 发送到另一个Handler，接收端的Handler 把MessageTask 交给 自己的isolate中的 worker 处理。<br>创建完线程需要对UI渲染，GPU发送渲染信号，在UI线程中 从 WidgetTree 将变化更新到Element中去生成 ElementTree 生成 RenderObject，接着布局、绘制，最终生成 LayerTree，接着给 GPU线程发送消息，进行Skia渲染<br>不同的平台可以通过MethodChannel实现不同平台的原生与flutter通信</p>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/flutter/" rel="tag"># Flutter</a>
              <a href="/tags/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3/" rel="tag"># 深入理解</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2019/12/04/flutter%E6%B8%B2%E6%9F%93%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/" rel="prev" title="flutter渲染原理分析">
      <i class="fa fa-chevron-left"></i> flutter渲染原理分析
    </a></div>
      <div class="post-nav-item">
    <a href="/2019/12/05/Flutter%E4%B8%8E%E5%8E%9F%E7%94%9F%E9%80%9A%E4%BF%A1%E5%AE%9E%E8%B7%B5/" rel="next" title="Flutter与原生通信实践">
      Flutter与原生通信实践 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%BC%95%E6%93%8E"><span class="nav-number">1.</span> <span class="nav-text">引擎</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%BC%96%E8%AF%91%E6%A1%86%E6%9E%B6"><span class="nav-number">2.</span> <span class="nav-text">编译框架</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E8%BF%9B%E7%A8%8B%E6%A1%86%E6%9E%B6"><span class="nav-number">3.</span> <span class="nav-text">进程框架</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%BA%BF%E7%A8%8B%E6%A1%86%E6%9E%B6"><span class="nav-number">4.</span> <span class="nav-text">线程框架</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Dart%E8%99%9A%E6%8B%9F%E6%9C%BA"><span class="nav-number">5.</span> <span class="nav-text">Dart虚拟机</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Widget-%E7%BB%93%E6%9E%84"><span class="nav-number">6.</span> <span class="nav-text">Widget 结构</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8E%9F%E7%94%9F%E9%80%9A%E4%BF%A1"><span class="nav-number">7.</span> <span class="nav-text">原生通信</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%80%BB%E7%BB%93"><span class="nav-number">8.</span> <span class="nav-text">总结</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="pacoblack"
      src="/images/avatar1.jpeg">
  <p class="site-author-name" itemprop="name">pacoblack</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">60</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">20</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">19</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/pacoblack" title="GitHub → https://github.com/pacoblack" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:pacoson.wang@gmail.com" title="E-Mail → mailto:pacoson.wang@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



      </div>
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">pacoblack</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  
  <script color='0,0,0' opacity='0.5' zIndex='-1' count='99' src="//cdn.bootcss.com/canvas-nest.js/1.0.0/canvas-nest.min.js"></script>
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

  
  <script type="text/javascript" src="//cdn.bootcss.com/canvas-nest.js/1.0.0/canvas-nest.min.js"></script>
  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer@1.10/dist/APlayer.min.css" class="aplayer-style-marker">
  <script src="https://cdn.jsdelivr.net/npm/aplayer@1.10/dist/APlayer.min.js" class="aplayer-script-marker"></script>
  <script src="https://cdn.jsdelivr.net/npm/meting@1.2/dist/Meting.min.js" class="meting-script-marker"></script>
  <div id="aplayer-AXqIDvNX"
      class="aplayer aplayer-tag-marker meting-tag-marker aplayer-fixed"
      data-id="71075946"
      data-server="netease"
      data-type="playlist"
      data-mode="circulation"
      data-autoplay="false"
      data-mutex="true"
      data-listmaxheight="340px"
      data-preload="auto"
      data-fixed="true"
      data-lrctype="0"
      data-theme="#555"></div>
<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"log":false,"model":{"jsonPath":"/live2dw/assets/Epsilon2.1.model.json"},"display":{"position":"right","width":150,"height":300},"mobile":{"show":true},"react":{"opacity":0.7}});</script></body>
</html>
