<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Flutter,深入理解,">










<meta name="description" content="先来看看Flutter的大体构造">
<meta name="keywords" content="Flutter,深入理解">
<meta property="og:type" content="article">
<meta property="og:title" content="flutter框架总览">
<meta property="og:url" content="https://pacoblack.github.io/2019/12/04/flutter框架总览/index.html">
<meta property="og:site_name" content="我爱学习">
<meta property="og:description" content="先来看看Flutter的大体构造">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://pacoblack.github.io/2019/12/04/flutter框架总览/flutter1.jpg">
<meta property="og:image" content="https://pacoblack.github.io/2019/12/04/flutter框架总览/flutter2.jpg">
<meta property="og:image" content="https://pacoblack.github.io/2019/12/04/flutter框架总览/flutter4.jpg">
<meta property="og:image" content="https://pacoblack.github.io/2019/12/04/flutter框架总览/flutter3.jpg">
<meta property="og:image" content="https://pacoblack.github.io/2019/12/04/flutter框架总览/flutter5.jpg">
<meta property="og:image" content="https://pacoblack.github.io/2019/12/04/flutter框架总览/flutter6.jpg">
<meta property="og:image" content="https://pacoblack.github.io/2019/12/04/flutter框架总览/isolate.jpg">
<meta property="og:image" content="https://pacoblack.github.io/2019/12/04/flutter框架总览/sendMsg.jpg">
<meta property="og:image" content="https://pacoblack.github.io/2019/12/04/flutter框架总览/flutter7.jpg">
<meta property="og:image" content="https://pacoblack.github.io/2019/12/04/flutter框架总览/flutter8.jpg">
<meta property="og:image" content="https://pacoblack.github.io/2019/12/04/flutter框架总览/flutter9.jpg">
<meta property="og:image" content="https://pacoblack.github.io/2019/12/04/flutter框架总览/flutter10.jpg">
<meta property="og:updated_time" content="2021-03-13T06:56:15.515Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="flutter框架总览">
<meta name="twitter:description" content="先来看看Flutter的大体构造">
<meta name="twitter:image" content="https://pacoblack.github.io/2019/12/04/flutter框架总览/flutter1.jpg">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":true,"scrollpercent":true,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://pacoblack.github.io/2019/12/04/flutter框架总览/">





  <title>flutter框架总览 | 我爱学习</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">我爱学习</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">这只是一场演习</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-主页"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-标签"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-分类"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-归档"></i> <br>
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-关于"></i> <br>
            
            关于
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://pacoblack.github.io/2019/12/04/flutter框架总览/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="pacoblack">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar1.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="我爱学习">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">flutter框架总览</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-12-04T19:08:48+08:00">
                2019-12-04
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/flutter/" itemprop="url" rel="index">
                    <span itemprop="name">Flutter</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/flutter/深入理解/" itemprop="url" rel="index">
                    <span itemprop="name">深入理解</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>先来看看Flutter的大体构造</p>
<a id="more"></a>
<h1 id="引擎"><a href="#引擎" class="headerlink" title="引擎"></a>引擎</h1><p><img src="//pacoblack.github.io/2019/12/04/flutter框架总览/flutter1.jpg" alt="对比"></p>
<p>安卓原生框架 APP 调到大家熟悉的安卓 Framework，Framework 再调到 Skia，Skia 再最终渲染调到 GPU。对于 Flutter 中间调的是一个 Dart Framework，再调到 Skia，用 Flutter 平台和原生很接近</p>
<p><img src="//pacoblack.github.io/2019/12/04/flutter框架总览/flutter2.jpg" alt="Engine"></p>
<p>上面是用 Dart 写的 APP，下面有 DartFramework，Framework 里有安卓和 iOS 的主体，里面有很多动画等等。再往下会调到引擎，引擎里有消息、PlatformChannel、Dart VM 等，引擎层再到平台。</p>
<blockquote>
<p>一个FlutterView对应一个FlutterEngine实例；<br>一个FlutterEngine实例对应一个Dart Isolate实例；<br>同一个进程只有且仅有一个Dart VM虚拟机；<br>一个Dart VM上会存在多个Dart Isolate实例，Isolate是dart代码的执行环境；</p>
</blockquote>
<h1 id="编译框架"><a href="#编译框架" class="headerlink" title="编译框架"></a>编译框架</h1><p><img src="//pacoblack.github.io/2019/12/04/flutter框架总览/flutter4.jpg" alt="flutter编译结构"></p>
<p>Dart 代码最上用前端编译器编译，下面左边绿色的是安卓，右边蓝色的是 iOS，根据不同的平台会产生不同的产物。</p>
<h1 id="进程框架"><a href="#进程框架" class="headerlink" title="进程框架"></a>进程框架</h1><p><img src="//pacoblack.github.io/2019/12/04/flutter框架总览/flutter3.jpg" alt="启动框架"></p>
<p>Flutter 有 Flutter 的 Application 和 Flutter 的 Activity。在 Flutter Application 中就会把 Dart 写的代码生成一个产物，把它加载起来，我们的 Flutter Activity 过程中会拉起我们的引擎。</p>
<p>引擎中，Flutter 四个核心线程：平台线程、UI 线程、GPU 线程、IO 线程，它们各有分工：</p>
<ul>
<li>平台线程，对于安卓和 iOS 来说就是常说的主线程，<br>一般来说，一个Flutter应用启动的时候会创建一个Engine实例，Engine创建的时候会创建一个线程供 Platform Runner 使用。跟Flutter Engine的所有交互（接口调用）必须在 Platform Thread 进行，否则可能导致无法预期的异常。这跟iOS UI相关的操作都必须在主线程进行相类似。需要注意的是在Flutter Engine中有很多模块都是非线程安全的。规则很简单，对于Flutter Engine的接口调用都需保证在Platform Thread进行。阻塞 Platform Thread 不会直接导致Flutter应用的卡顿（跟iOS android主线程不同）。尽管如此，也不建议在这个Runner执行繁重的操作，长时间卡住Platform Thread应用有可能会被系统Watchdog强杀。</li>
<li>UI 线程，面对安卓本身的主线程，就是一个独立的线程；UI Task Runner用于执行Dart root isolate代码<br>Root isolate比较特殊，它绑定了不少Flutter需要的函数方法，以便进行渲染相关操作。对于每一帧，引擎要做的事情有：<ol>
<li>Root isolate通知Flutter Engine有帧需要渲染。</li>
<li>Flutter Engine通知平台，需要在下一个vsync的时候得到通知。</li>
<li>平台等待下一个vsync</li>
<li>对创建的对象和Widgets进行Layout并生成一个Layer Tree，这个Tree马上被提交给Flutter Engine。当前阶段没有进行任何光栅化，这个步骤仅是生成了对需要绘制内容的描述。</li>
<li>创建或者更新Tree，这个Tree包含了用于屏幕上显示Widgets的语义信息。这个东西主要用于平台相关的辅助Accessibility元素的配置和渲染。<br>除了渲染相关逻辑之外Root Isolate还是处理来自Native Plugins的消息，Timers，Microtasks和异步IO等操作。Root Isolate负责创建管理的Layer Tree最终决定绘制到屏幕上的内容。因此这个线程的过载会直接导致卡顿掉帧。</li>
</ol>
</li>
<li>GPU 线程，指的是跑在 CPU 上的线程，它做的主要是 Skia 相关工作。<br>UI Task Runner创建的Layer Tree是跨平台的，它不关心到底由谁来完成绘制。GPU Task Runner负责将Layer Tree提供的信息转化为平台可执行的GPU指令。GPU Task Runner同时负责绘制所需要的GPU资源的管理。资源主要包括平台Framebuffer，Surface，Texture和Buffers等。</li>
</ul>
<p>一般来说UI Runner和GPU Runner跑在不同的线程。GPU Runner会根据目前帧执行的进度去向UI Runner要求下一帧的数据，在任务繁重的时候可能会告诉UI Runner延迟任务。这种调度机制确保GPU Runner不至于过载，同时也避免了UI Runner不必要的消耗。</p>
<p>建议为每一个Engine实例都新建一个专用的GPU Runner线程。</p>
<ul>
<li>IO 线程，比如图片解码、编解码，主要做 IO 相关的工作。<br>Platform Runner过载可能导致系统WatchDog强杀，UI和GPU Runner过载则可能导致Flutter应用的卡顿。但是GPU线程的一些必要操作，例如IO，放到哪里执行呢？答案正是IO Runner。</li>
</ul>
<p>IO Runner的主要功能是从图片存储（比如磁盘）中读取压缩的图片格式，将图片数据进行处理为GPU Runner的渲染做好准备。IO Runner首先要读取压缩的图片二进制数据（比如PNG，JPEG），将其解压转换成GPU能够处理的格式然后将数据上传到GPU。</p>
<p>获取诸如ui.Image这样的资源只有通过async call去调用，当调用发生的时候Flutter Framework告诉IO Runner进行加载的异步操作。</p>
<p>IO Runner直接决定了图片和其它一些资源加载的延迟间接影响性能。所以建议为IO Runner创建一个专用的线程。</p>
<h1 id="线程框架"><a href="#线程框架" class="headerlink" title="线程框架"></a>线程框架</h1><p><img src="//pacoblack.github.io/2019/12/04/flutter框架总览/flutter5.jpg" alt="线程通信"></p>
<p>以安卓为例，Flutter 依然有一个 Looper 线程，对于主线程复用了原来的 Native 的，对于另外三个线程创建的独立的 Looper，不同的是它有两个消息队列，依然是发送消息的方式，通过 Task Runner 就好比安卓的 Handler，通过 PostTask 就好比把一个消息放在一个消息队列里去。同样在 Dart 里经常用 Furture 和异步的方法，核心还是用 Task Runner 发一个消息。</p>
<h1 id="Dart虚拟机"><a href="#Dart虚拟机" class="headerlink" title="Dart虚拟机"></a>Dart虚拟机</h1><p><img src="//pacoblack.github.io/2019/12/04/flutter框架总览/flutter6.jpg" alt="Dart虚拟机"></p>
<p>同一个进程里可以有很多 Isolate，两个 Isolate 的堆是不能共享的，但它们也可以交互。在 Dart 虚拟机里面也有一个特殊 Isolate，是运行在 UI 线程中，和 Root Isolate 是运行在一个线程的。当两个 Isolate 要通信，会找一个共同的可访问的内存。</p>
<p><img src="//pacoblack.github.io/2019/12/04/flutter框架总览/isolate.jpg" alt="isolate"></p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//在父Isolate中调用</span></span><br><span class="line">Isolate isolate;</span><br><span class="line">start() <span class="keyword">async</span> &#123;</span><br><span class="line">  ReceivePort receivePort = ReceivePort();</span><br><span class="line">  <span class="comment">//创建子Isolate对象</span></span><br><span class="line">  isolate = <span class="keyword">await</span> Isolate.spawn(getMsg, receivePort.sendPort);</span><br><span class="line">  <span class="comment">//监听子Isolate的返回数据</span></span><br><span class="line">  receivePort.listen((data) &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">'data：<span class="subst">$data</span>'</span>);</span><br><span class="line">    receivePort.close();</span><br><span class="line">    <span class="comment">//关闭Isolate对象</span></span><br><span class="line">    isolate?.kill(priority: Isolate.immediate);</span><br><span class="line">    isolate = <span class="keyword">null</span>;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//子Isolate对象的入口函数，可以在该函数中做耗时操作</span></span><br><span class="line">getMsg(sendPort) =&gt; sendPort.send(<span class="string">"hello"</span>);</span><br></pre></td></tr></table></figure>

<p>创建Isolate时会将其中的MessageHandler对象添加到一个全局的map，（在Dart VM初始化的时候创建，每个元素都是一个Entry对象，在Entry中，有一个MessageHandler对象，一个端口号及该端口的状态。），接着创建 ReceivePort 对象，ReceivePort对应着Dart SDK中的_RawReceivePortImpl对象，SendPort对应着Dart SDK中的_SendPortImpl对象。当ReceivePort创建成功后，就可以通过调用_SendPortImpl的send函数来发送消息。send 发送消息时，将消息加入到了目标Isolate的MessageHandler中，<br>在PostMessage中主要是做了以下操作</p>
<ol>
<li>根据消息级别将消息加入到不同的队列中。主要有OOB消息及普通消息两个级别，OOB消息在队列oob_queue_中，普通消息在队列queue_中。OOB消息级别高于普通消息，会立即处理。</li>
<li>将一个消息处理任务MessageHandlerTask加入到线程中。</li>
</ol>
<p>普通消息的处理</p>
<ol>
<li>首先调用Dart SDK中_RawReceivePortImpl对象的_lookupHandler函数，返回一个在创建_RawReceivePortImpl对象时注册的一个自定义函数。</li>
<li>调用Dart SDK中_RawReceivePortImpl对象的_handleMessage函数并传入1中返回的自定义函数，通过该自定义函数将消息分发出去</li>
</ol>
<p>双向通信也很简单，在父Isolate中创建一个端口，并在创建子Isolate时，将这个端口传递给子Isolate。然后在子Isolate调用其入口函数时也创建一个新端口，并通过父Isolate传递过来的端口把子Isolate创建的端口传递给父Isolate，这样父Isolate与子Isolate分别拥有对方的一个端口号，从而实现了通信</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//当前函数在父Isolate中</span></span><br><span class="line">Future&lt;<span class="keyword">dynamic</span>&gt; asyncFactoriali(n) <span class="keyword">async</span> &#123;</span><br><span class="line">  <span class="comment">//父Isolate对应的ReceivePort对象</span></span><br><span class="line">  <span class="keyword">final</span> response = ReceivePort();</span><br><span class="line">  <span class="comment">//创建一个子Isolate对象</span></span><br><span class="line">  <span class="keyword">await</span> Isolate.spawn(_isolate, response.sendPort);</span><br><span class="line">  <span class="keyword">final</span> sendPort = <span class="keyword">await</span> response.first <span class="keyword">as</span> SendPort;</span><br><span class="line">  <span class="keyword">final</span> answer = ReceivePort();</span><br><span class="line">  <span class="comment">//给子Isolate发送数据</span></span><br><span class="line">  sendPort.send([n, answer.sendPort]);</span><br><span class="line">  <span class="keyword">return</span> answer.first;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//子Isolate的入口函数，可以在该函数中做耗时操作</span></span><br><span class="line"><span class="comment">//_isolate必须是顶级函数（不能存在任何类中）或者是静态函数（可以存在类中）</span></span><br><span class="line">_isolate(SendPort initialReplyTo) <span class="keyword">async</span> &#123;</span><br><span class="line">  <span class="comment">//子Isolate对应的ReceivePort对象</span></span><br><span class="line">  <span class="keyword">final</span> port = ReceivePort();</span><br><span class="line">  initialReplyTo.send(port.sendPort);</span><br><span class="line">  <span class="keyword">final</span> message = <span class="keyword">await</span> port.first <span class="keyword">as</span> <span class="built_in">List</span>;</span><br><span class="line">  <span class="keyword">final</span> data = message[<span class="number">0</span>] <span class="keyword">as</span> <span class="built_in">int</span>;</span><br><span class="line">  <span class="keyword">final</span> send = message[<span class="number">1</span>] <span class="keyword">as</span> SendPort;</span><br><span class="line">  <span class="comment">//给父Isolate的返回数据</span></span><br><span class="line">  send.send(syncFactorial(data));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//运行代码</span></span><br><span class="line">start() <span class="keyword">async</span> &#123;</span><br><span class="line">  <span class="built_in">print</span>(<span class="string">"计算结果：<span class="subst">$&#123;await asyncFactoriali(<span class="number">4</span>)&#125;</span>"</span>);</span><br><span class="line">&#125;</span><br><span class="line">start();</span><br></pre></td></tr></table></figure>

<p><img src="//pacoblack.github.io/2019/12/04/flutter框架总览/sendMsg.jpg" alt="过程图"><br><a href="https://juejin.im/post/5e149a7df265da5d3b32e167#heading-6" target="_blank" rel="noopener">原文</a></p>
<p>Isolate1 和 Isolate2 通信是在 Isolate2 里创一个 ReceivePort，在 Isolate1 中调用其对应的 SendPort 的 send 方法，在引擎 PortMap 里面有映射表，每一个 port 端口对应一个相应 Isolate 的 MessageHandler，该 Handler 里面有两个队列，一个是普通的消息队列，一个是 OOB 高优先级消息，根据优先级把它放到相应消息队列。再把这个 <strong>事件封装成一个 MessageTask，抛到另外一个 Isolate 里去</strong>，我们一般创建一个 Isolate，它里面是一个 worker 线程，worker 线程放入一个新的 Task，它就会最终去执行这个 Task</p>
<h1 id="Widget-结构"><a href="#Widget-结构" class="headerlink" title="Widget 结构"></a>Widget 结构</h1><p><img src="//pacoblack.github.io/2019/12/04/flutter框架总览/flutter7.jpg" alt="Widget"></p>
<p>Widget 可以是一行文本、一张图片、一个颜色，所有都是 Widget。最大有两类，一个是无状态的 Widget，一个是有状态的。无状态顾名思义是一类 StatelessWidget，一旦创建状态是不可改变的；第二类 StatefulWidget 是状态可以改变的<br><img src="//pacoblack.github.io/2019/12/04/flutter框架总览/flutter8.jpg" alt="Widget渲染"></p>
<p>对应 Widget 创建 Widget 树，它是 Element 的配置，如果两个 Widget 之间做了变化它会做差分，比较一下到底哪部分做了变化，只把变化更新到 Element 里去，以最小粒度做更新。到了 Element 里构建渲染过程中会创建 Render 对象，创建渲染的过程。</p>
<p><img src="//pacoblack.github.io/2019/12/04/flutter框架总览/flutter9.jpg" alt="渲染原理"><br>渲染来了一个信号，<strong>UI 线程</strong> 更新动画，动画完了会生成 Render，再往下布局、绘制大小等工作，最终生成一个 Layer Tree。</p>
<p>接着会到 <strong>GPU 线程</strong> 调用 Skia 做渲染</p>
<h1 id="原生通信"><a href="#原生通信" class="headerlink" title="原生通信"></a>原生通信</h1><p><img src="//pacoblack.github.io/2019/12/04/flutter框架总览/flutter10.jpg" alt="Channel"></p>
<p>橙色部分代码，写相应平台安卓或者 iOS 定制代码，中间有一套封装好的机制，通过 Dart 代码直接可以调到安卓或者 iOS 代码，且这个过程是异步的。</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>Flutter 是会根据ios和安卓编译生成不同的执行文件，android是生成一个flutter.jar。<br>以安卓为例，flutter的启动也是依赖原生的application来启动，并同时生成四个线程，四个线程的通信与Android原生的Handler通信类似，也是发送消息，区别在于另外三个线程公用两个队列，另外进程间通信与原生不同，不能直接通信，需要一个共享内存，这个共享内存位于flutter 引擎，记录不同线程的 sendPort 和 receivePort，每个port对应一个 MessageHandler，发送的消息会封装成一个MessageTask 发送到另一个Handler，接收端的Handler 把MessageTask 交给 自己的isolate中的 worker 处理。<br>创建完线程需要对UI渲染，GPU发送渲染信号，在UI线程中 从 WidgetTree 将变化更新到Element中去生成 ElementTree 生成 RenderObject，接着布局、绘制，最终生成 LayerTree，接着给 GPU线程发送消息，进行Skia渲染<br>不同的平台可以通过MethodChannel实现不同平台的原生与flutter通信</p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/flutter/" rel="tag"># Flutter</a>
          
            <a href="/tags/深入理解/" rel="tag"># 深入理解</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/12/04/flutter渲染原理分析/" rel="next" title="flutter渲染原理分析">
                <i class="fa fa-chevron-left"></i> flutter渲染原理分析
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/12/05/Flutter与原生通信实践/" rel="prev" title="Flutter与原生通信实践">
                Flutter与原生通信实践 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/avatar1.jpeg" alt="pacoblack">
            
              <p class="site-author-name" itemprop="name">pacoblack</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">49</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">18</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">17</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/pacoblack" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:pacoson.wang@gmail.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://instagram.com/pacoblacksee" target="_blank" title="Instagram">
                      
                        <i class="fa fa-fw fa-instagram"></i>Instagram</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="skype:yourname?call|chat" target="_blank" title="Skype">
                      
                        <i class="fa fa-fw fa-skype"></i>Skype</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#引擎"><span class="nav-number">1.</span> <span class="nav-text">引擎</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#编译框架"><span class="nav-number">2.</span> <span class="nav-text">编译框架</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#进程框架"><span class="nav-number">3.</span> <span class="nav-text">进程框架</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#线程框架"><span class="nav-number">4.</span> <span class="nav-text">线程框架</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Dart虚拟机"><span class="nav-number">5.</span> <span class="nav-text">Dart虚拟机</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Widget-结构"><span class="nav-number">6.</span> <span class="nav-text">Widget 结构</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#原生通信"><span class="nav-number">7.</span> <span class="nav-text">原生通信</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#总结"><span class="nav-number">8.</span> <span class="nav-text">总结</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      
        <div class="back-to-top">
          <i class="fa fa-arrow-up"></i>
          
            <span id="scrollpercent"><span>0</span>%</span>
          
        </div>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">pacoblack</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div>




        







        
      </div>
    </footer>

    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="[object Object]"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

  
  <script type="text/javascript" src="//cdn.bootcss.com/canvas-nest.js/1.0.0/canvas-nest.min.js"></script>
  
  <link rel="stylesheet" href="/assets/css/APlayer.min.css" class="aplayer-style-marker">
  <script src="/assets/js/APlayer.min.js" class="aplayer-script-marker"></script>
  <script src="/assets/js/Meting.min.js" class="meting-script-marker"></script>
  <div id="aplayer-AXqIDvNX" class="aplayer aplayer-tag-marker meting-tag-marker aplayer-fixed" data-id="71075946" data-server="netease" data-type="playlist" data-mode="circulation" data-autoplay="false" data-mutex="true" data-listmaxheight="340px" data-preload="auto" data-fixed="true" data-lrctype="0" data-theme="#555"></div>
<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"log":false,"model":{"jsonPath":"/live2dw/assets/Epsilon2.1.model.json"},"display":{"position":"right","width":150,"height":300},"mobile":{"show":true},"react":{"opacity":0.7}});</script></body>
</html>
