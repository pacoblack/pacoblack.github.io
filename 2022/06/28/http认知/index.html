<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"pacoblack.github.io","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":true,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="http协议目前已更新到3.0">
<meta property="og:type" content="article">
<meta property="og:title" content="http认知">
<meta property="og:url" content="https://pacoblack.github.io/2022/06/28/http%E8%AE%A4%E7%9F%A5/index.html">
<meta property="og:site_name" content="我爱学习">
<meta property="og:description" content="http协议目前已更新到3.0">
<meta property="og:locale">
<meta property="og:image" content="https://pacoblack.github.io/quic_nat.jpeg">
<meta property="og:image" content="https://pacoblack.github.io/quic_vs_tcp.webp">
<meta property="og:image" content="https://pacoblack.github.io/http2_vs_http3.jpeg">
<meta property="og:image" content="https://pacoblack.github.io/quic_model.jpeg">
<meta property="og:image" content="https://pacoblack.github.io/quick_package.jpeg">
<meta property="og:image" content="https://pacoblack.github.io/okhttp_2.awebp">
<meta property="article:published_time" content="2022-06-28T02:31:06.000Z">
<meta property="article:modified_time" content="2022-06-30T06:34:25.912Z">
<meta property="article:author" content="pacoblack">
<meta property="article:tag" content="android">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://pacoblack.github.io/quic_nat.jpeg">

<link rel="canonical" href="https://pacoblack.github.io/2022/06/28/http%E8%AE%A4%E7%9F%A5/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-Hans'
  };
</script>

  <title>http认知 | 我爱学习</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">我爱学习</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">这只是一场演习</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="主页 fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="标签 fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="分类 fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="归档 fa-fw"></i>Archives</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="关于 fa-fw"></i>About</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="https://pacoblack.github.io/2022/06/28/http%E8%AE%A4%E7%9F%A5/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar1.jpeg">
      <meta itemprop="name" content="pacoblack">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="我爱学习">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          http认知
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-06-28 10:31:06" itemprop="dateCreated datePublished" datetime="2022-06-28T10:31:06+08:00">2022-06-28</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-06-30 14:34:25" itemprop="dateModified" datetime="2022-06-30T14:34:25+08:00">2022-06-30</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/android/" itemprop="url" rel="index"><span itemprop="name">android</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>http协议目前已更新到3.0</p>
<span id="more"></span>

<h1><span id="rtt">RTT</span></h1><p>RTT是Round Trip Time的缩写，通俗地说，就是通信一来一回的时间。</p>
<h2><span id="tcp的rtt">TCP的RTT</span></h2><p>TCP需要三次握手，建立TCP的虚拟通道，那么这三次握手需要几个RTT时间？<br>去 （SYN）     —-&gt;<br>回 （SYN+ACK） &lt;—-<br>去 （ACK）     —-&gt;<br>一个半来回，故TCP连接的时间 &#x3D; 1.5 RTT 。</p>
<h2><span id="http的rtt">HTTP的RTT</span></h2><p>用户在浏览器输入URL，1.5个RTT之后，TCP开始传输HTTP Request，浏览器收到服务器的 Response，又花费了1 RTT<br>HTTP的同心时间 &#x3D; TCP握手时间 + HTTP交易时间 &#x3D; 1.5RTT + 1 RTT &#x3D; 2.5 RTT</p>
<h2><span id="ssl-与-tls">SSL 与 TLS</span></h2><p>为了保证数据安全，发明了SSL（Secure Socket Layer），位于TCP和HTTP之间，负责HTT的安全加密<br>但是最初的SSL只能加密HTTP，为了能更大范围的使用，在协议中增加了 Application Protocol 字段<br>在SSL 3.0版本上，添加了这个协议，更名为TLS 报文格式如下：<br>IP&#x2F;TCP&#x2F;TLS&#x2F;[HTTP]</p>
<p>当前浏览器支持的TLS版本为 1.0 1.1 1.2<br>通常将TLS保护的HTTP通信，称为HTTPS</p>
<h2><span id="tls-12的rtt">TLS 1.2的RTT</span></h2><ol>
<li>客户端发送 Client Hello —- ‘我支持1.2版本，加密套件列表1、2、3…，以及我的随机码N1，请出示您的证件。’</li>
<li>服务端回复 Server Hello —- ‘那就1.2版本通信吧，加密套件我选用1，我的随机码N2，ECDHE密钥交换素材2，这是我的证件。’</li>
<li>客户端发送 Key Exchange —- ‘验证首长的证件是否伪造的；生成密钥交换素材1；回复我的ECDHE密钥交换素材1，接下来我发给您的消息都要加密了’<br>花费时间总和&#x3D; TCP链接建立时间+ TLS建立时间 +HTTP交易时间 &#x3D; 1.5 RTT + 1.5RTT + 1RTT &#x3D; 4 RTT</li>
</ol>
<h1><span id="http-1x">HTTP 1.x</span></h1><p>客户端从服务端获取页面，页面中包含很多资源链接，浏览器去加载链接资源的时候，需要重新建立 TCP、TLS、HTTP<br>完整的页面加载时间 &#x3D; 4RTT + 4RTT &#x3D; 8RTT</p>
<h1><span id="http-20">HTTP 2.0</span></h1><p>如果第一个页面和第二个页面是同一个服务器，为什么要重新建立 TCP、TLS链接呢，我们可以进行优化<br>用户多个HTTP请求，使用同一个通道进行传输，可以减少很多时间<br>但是副作用是，多个HTTP使用一个TCP连接，需要遵守流量状态控制，如果某个HTTP遇到阻塞，那么后面的HTTP就会无法发送，这就是头部阻塞</p>
<h2><span id="quicquick-udp-internet-connection">QUIC(Quick UDP Internet Connection)</span></h2><p>报文格式：<em>IP&#x2F;UDP&#x2F;QUIC</em><br>Google开发了QUIC协议，它集成了TCP可靠传输机制、TLS安全机制、HTTP2.0 流量复用机制，其页面加载时间是2.5RTT</p>
<h3><span id="升级困难">升级困难</span></h3><p>QUIC 的实现在传输层换了协议，从 TCP 换到了 UDP，这个变化可不是说升级就升级的。<br>一个官方的例子：NAT 网关。NAT 网关对 TCP 的映射是根据 source_ip:port 和 destination_ip:port 来做的，经过 NAT 网关的 TCP 流量都通过这个四元组做识别，监听 SYN 和 ACK 可以确定 TCP 链接是否建立是否断开；而 NAT 网关对 UDP 流量的处理却没有这么可靠，对于 UDP 流量，NAT 的端口映射可能在某次传输超时之后就被重新分配了，这本来对 UDP 的不可靠的流量也不那么严重，但 QUIC 基于这种实际情况下做，某个建立好要复用的链接，对 NAT 内部机器来说流量来源的端口是会发生变化的，从而四元组做链接标识的事情就 GG 了。如下图：<br><img src="/quic_nat.jpeg" alt="nat"><br>为了解决上面的问题，QUIC 使用一个通用的 QUIC Connection ID 来解决这个问题，绕过四元组。</p>
<h1><span id="http30">HTTP3.0</span></h1><p>IETF希望QUIC不仅可以传输HTTP，也可以传输其他协议，把QUIC和HTTP分离<br>报文格式： <em>IP &#x2F;UDP&#x2F;QUIC&#x2F;HTTP</em><br>整体的页面加载时间是 2RTT</p>
<h2><span id="tls-13">TLS 1.3</span></h2><p>建立TLS连接不再需要1.5 RTT，而只需要1 RTT，是因为浏览器第一次就把自己的密钥交换的素材发给服务器，这样就节省了第三次消息，少了0.5个RTT时间。<br>页面的整体加载时间 &#x3D; TLS 1.3连接时间 + HTTP交易时间 &#x3D; 1RTT + 1RTT &#x3D; 2 RTT<br>重连页面的加载时间 &#x3D; HTTP交易时间 &#x3D; 1 RTT</p>
<h1><span id="小结">小结</span></h1><p>HTTP&#x2F;2 虽然具有多个流并发传输的能力，但是传输层是 TCP 协议，于是存在以下缺陷：</p>
<ul>
<li><em>队头阻塞</em>，HTTP&#x2F;2 多个请求跑在一个 TCP 连接中，如果序列号较低的 TCP 段在网络传输中丢失了，即使序列号较高的 TCP 段已经被接收了，应用层也无法从内核中读取到这部分数据，从 HTTP 视角看，就是多个请求被阻塞了；</li>
<li><em>TCP 和 TLS 握手时延</em>，TCL 三次握手和 TLS 四次握手，共有 3-RTT 的时延；</li>
<li><em>连接迁移需要重新连接</em>，移动设备从 4G 网络环境切换到 WIFI 时，由于 TCP 是基于四元组来确认一条 TCP 连接的，那么网络环境变化后，就会导致 IP 地址或端口变化，于是 TCP 只能断开连接，然后再重新建立连接，切换网络环境的成本高；</li>
</ul>
<h1><span id="附图">附图</span></h1><p><img src="/quic_vs_tcp.webp" alt="连接demo"><br><img src="/http2_vs_http3.jpeg" alt="比较报文"></p>
<h1><span id="quic的无队头阻塞解决方案">QUIC的无队头阻塞解决方案</span></h1><p>QUIC 同样是一个可靠的协议，它使用 Packet Number 代替了 TCP 的 Sequence Number，并且每个 Packet Number 都严格递增，也就是说就算 Packet N 丢失了，重传的 Packet N 的 Packet Number 已经不是 N，而是一个比 N 大的值，比如Packet N+M。</p>
<p>QUIC 使用的Packet Number 单调递增的设计，可以让数据包不再像TCP 那样必须有序确认，QUIC 支持乱序确认，当数据包Packet N 丢失后，只要有新的已接收数据包确认，当前窗口就会继续向右滑动。待发送端获知数据包Packet N 丢失后，会将需要重传的数据包放到待发送队列，重新编号比如数据包Packet N+M 后重新发送给接收端，对重传数据包的处理跟发送新的数据包类似，这样就不会因为丢包重传将当前窗口阻塞在原地，从而解决了队头阻塞问题。那么，既然重传数据包的Packet N+M 与丢失数据包的Packet N 编号并不一致，我们怎么确定这两个数据包的内容一样呢？</p>
<p>QUIC使用Stream ID 来标识当前数据流属于哪个资源请求，这同时也是数据包多路复用传输到接收端后能正常组装的依据。重传的数据包Packet N+M 和丢失的数据包Packet N 单靠Stream ID 的比对一致仍然不能判断两个数据包内容一致，还需要再新增一个字段Stream Offset，标识当前数据包在当前Stream ID 中的字节偏移量。</p>
<p>有了Stream Offset 字段信息，属于同一个Stream ID 的数据包也可以乱序传输了（HTTP&#x2F;2 中仅靠Stream ID 标识，要求同属于一个Stream ID 的数据帧必须有序传输），通过两个数据包的Stream ID 与 Stream Offset 都一致，就说明这两个数据包的内容一致。<br><img src="/quic_model.jpeg" alt="quic"></p>
<h2><span id="quic协议">QUIC协议</span></h2><p>QUIC 的 packet 除了个别报文比如 PUBLIC_RESET 和 CHLO，所有报文头部都是经过认证的，报文 Body 都是经过加密的。这样只要对 QUIC 报文任何修改，接收端都能够及时发现，有效地降低了安全风险。如图所示，红色部分是 Stream Frame 的报文头部，有认证。绿色部分是报文内容，全部经过加密。<br><img src="/quick_package.jpeg" alt="报文"></p>
<ul>
<li>Flags：用于表示Connection ID长度、Packet Number长度等信息；</li>
<li>Connection ID：客户端随机选择的最大长度为64位的无符号整数。但是，长度可以协商；</li>
<li>QUIC Version：QUIC协议的版本号，32位的可选字段。如果Public Flag &amp; FLAG_VERSION !&#x3D; 0，这个字段必填。客户端设置Public Flag 中的 Bit0 为1，并且填写期望的版本号。 如果客户端期望的版本号服务端不支持，服务端设置 Public Flag中的 Bit0 为 1，并且在该字段中列出服务端支持的协议版本（0或者多个），并且该字段后不能有任何报文；</li>
<li>Packet Number：长度取决于Public Flag中Bit4及Bit5两位的值，最大长度6字节。发送端在每个普通报文中设置Packet Number。 发送端发送的第一个包的序列号是1，随后的数据包中的序列号的都大于前一个包中的序列号；</li>
<li>Stream ID：用于标识当前数据流属于哪个资源请求；</li>
<li>Offset：标识当前数据包在当前Stream ID 中的字节偏移量；</li>
</ul>
<p>QUIC报文的大小需要满足路径MTU的大小以避免被分片。当前QUIC在IPV6下的最大报文长度为1350，IPV4下的最大报文长度为1370。</p>
<h1><span id="开启http20">开启HTTP2.0</span></h1><p><img src="/okhttp_2.awebp" alt="流程图"></p>
<p>从拦截器实现可以发现，Okhttp实现了一个连接池，当ConnectionInterceptor被调用的时候，先是判断连接池内有没有空闲并且健康的可用连接，然后再使用连接去调度下一个拦截器，那么也就是一个tcp连接的存活时间是大于Http请求的，所以一个Tcp可以对应多个Http请求。</p>
<p>我们主要说些connet方法，它是整个Http2.0的开启流程的关键。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">connect</span><span class="params">(<span class="type">int</span> connectTimeout, <span class="type">int</span> readTimeout, <span class="type">int</span> writeTimeout,</span></span><br><span class="line"><span class="params">     <span class="type">int</span> pingIntervalMillis, <span class="type">boolean</span> connectionRetryEnabled, Call call,</span></span><br><span class="line"><span class="params">     EventListener eventListener)</span> &#123;</span><br><span class="line">   <span class="keyword">if</span> (protocol != <span class="literal">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;already connected&quot;</span>);</span><br><span class="line"></span><br><span class="line">   <span class="type">RouteException</span> <span class="variable">routeException</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">   List&lt;ConnectionSpec&gt; connectionSpecs = route.address().connectionSpecs();</span><br><span class="line">   <span class="type">ConnectionSpecSelector</span> <span class="variable">connectionSpecSelector</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConnectionSpecSelector</span>(connectionSpecs);</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> (route.address().sslSocketFactory() == <span class="literal">null</span>) &#123;</span><br><span class="line">     <span class="keyword">if</span> (!connectionSpecs.contains(ConnectionSpec.CLEARTEXT)) &#123;</span><br><span class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RouteException</span>(<span class="keyword">new</span> <span class="title class_">UnknownServiceException</span>(</span><br><span class="line">           <span class="string">&quot;CLEARTEXT communication not enabled for client&quot;</span>));</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="type">String</span> <span class="variable">host</span> <span class="operator">=</span> route.address().url().host();</span><br><span class="line">     <span class="keyword">if</span> (!Platform.get().isCleartextTrafficPermitted(host)) &#123;</span><br><span class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RouteException</span>(<span class="keyword">new</span> <span class="title class_">UnknownServiceException</span>(</span><br><span class="line">           <span class="string">&quot;CLEARTEXT communication to &quot;</span> + host + <span class="string">&quot; not permitted by network security policy&quot;</span>));</span><br><span class="line">     &#125;</span><br><span class="line">   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">     <span class="keyword">if</span> (route.address().protocols().contains(Protocol.H2_PRIOR_KNOWLEDGE)) &#123;</span><br><span class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RouteException</span>(<span class="keyword">new</span> <span class="title class_">UnknownServiceException</span>(</span><br><span class="line">           <span class="string">&quot;H2_PRIOR_KNOWLEDGE cannot be used with HTTPS&quot;</span>));</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">     <span class="keyword">try</span> &#123;</span><br><span class="line">       <span class="keyword">if</span> (route.requiresTunnel()) &#123;</span><br><span class="line">         connectTunnel(connectTimeout, readTimeout, writeTimeout, call, eventListener);</span><br><span class="line">         <span class="keyword">if</span> (rawSocket == <span class="literal">null</span>) &#123;</span><br><span class="line">           <span class="comment">// We were unable to connect the tunnel but properly closed down our resources.</span></span><br><span class="line">           <span class="keyword">break</span>;</span><br><span class="line">         &#125;</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">         connectSocket(connectTimeout, readTimeout, call, eventListener);</span><br><span class="line">       &#125;</span><br><span class="line">       establishProtocol(connectionSpecSelector, pingIntervalMillis, call, eventListener);</span><br><span class="line">       eventListener.connectEnd(call, route.socketAddress(), route.proxy(), protocol);</span><br><span class="line">       <span class="keyword">break</span>;</span><br><span class="line">     &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">       closeQuietly(socket);</span><br><span class="line">       closeQuietly(rawSocket);</span><br><span class="line">       socket = <span class="literal">null</span>;</span><br><span class="line">       rawSocket = <span class="literal">null</span>;</span><br><span class="line">       source = <span class="literal">null</span>;</span><br><span class="line">       sink = <span class="literal">null</span>;</span><br><span class="line">       handshake = <span class="literal">null</span>;</span><br><span class="line">       protocol = <span class="literal">null</span>;</span><br><span class="line">       http2Connection = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">       eventListener.connectFailed(call, route.socketAddress(), route.proxy(), <span class="literal">null</span>, e);</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (routeException == <span class="literal">null</span>) &#123;</span><br><span class="line">         routeException = <span class="keyword">new</span> <span class="title class_">RouteException</span>(e);</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">         routeException.addConnectException(e);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (!connectionRetryEnabled || !connectionSpecSelector.connectionFailed(e)) &#123;</span><br><span class="line">         <span class="keyword">throw</span> routeException;</span><br><span class="line">       &#125;</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> (route.requiresTunnel() &amp;&amp; rawSocket == <span class="literal">null</span>) &#123;</span><br><span class="line">     <span class="type">ProtocolException</span> <span class="variable">exception</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ProtocolException</span>(<span class="string">&quot;Too many tunnel connections attempted: &quot;</span></span><br><span class="line">         + MAX_TUNNEL_ATTEMPTS);</span><br><span class="line">     <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RouteException</span>(exception);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> (http2Connection != <span class="literal">null</span>) &#123;</span><br><span class="line">     <span class="keyword">synchronized</span> (connectionPool) &#123;</span><br><span class="line">       allocationLimit = http2Connection.maxConcurrentStreams();</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>其中while true 循环内会去构建一个socket连接，当socket连接构建成功之后，会调用<code>establishProtocol</code>方法，这个就是整篇文章的主角了。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">establishProtocol</span><span class="params">(ConnectionSpecSelector connectionSpecSelector,</span></span><br><span class="line"><span class="params">    <span class="type">int</span> pingIntervalMillis, Call call, EventListener eventListener)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">  <span class="keyword">if</span> (route.address().sslSocketFactory() == <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (route.address().protocols().contains(Protocol.H2_PRIOR_KNOWLEDGE)) &#123;</span><br><span class="line">      socket = rawSocket;</span><br><span class="line">      protocol = Protocol.H2_PRIOR_KNOWLEDGE;</span><br><span class="line">      startHttp2(pingIntervalMillis);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    socket = rawSocket;</span><br><span class="line">    protocol = Protocol.HTTP_1_1;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  eventListener.secureConnectStart(call);</span><br><span class="line">  connectTls(connectionSpecSelector);</span><br><span class="line">  eventListener.secureConnectEnd(call, handshake);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (protocol == Protocol.HTTP_2) &#123;</span><br><span class="line">    startHttp2(pingIntervalMillis);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>看到最后几行代码，其实已经能知道了。只要当前协议包含了HTTP_2，OKhttp就会开启Http2.0模式，否则则降级成1.1的代码。而如何去获取协议就是connectTls这个方法了，而且Tls完整流程都在方法内。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">connectTls</span><span class="params">(ConnectionSpecSelector connectionSpecSelector)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="type">Address</span> <span class="variable">address</span> <span class="operator">=</span> route.address();</span><br><span class="line">    <span class="type">SSLSocketFactory</span> <span class="variable">sslSocketFactory</span> <span class="operator">=</span> address.sslSocketFactory();</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="type">SSLSocket</span> <span class="variable">sslSocket</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// Create the wrapper over the connected socket.</span></span><br><span class="line">      sslSocket = (SSLSocket) sslSocketFactory.createSocket(</span><br><span class="line">          rawSocket, address.url().host(), address.url().port(), <span class="literal">true</span> <span class="comment">/* autoClose */</span>);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Configure the socket&#x27;s ciphers, TLS versions, and extensions.</span></span><br><span class="line">      <span class="type">ConnectionSpec</span> <span class="variable">connectionSpec</span> <span class="operator">=</span> connectionSpecSelector.configureSecureSocket(sslSocket);</span><br><span class="line">      <span class="keyword">if</span> (connectionSpec.supportsTlsExtensions()) &#123;</span><br><span class="line">        Platform.get().configureTlsExtensions(</span><br><span class="line">            sslSocket, address.url().host(), address.protocols());</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Force handshake. This can throw!</span></span><br><span class="line">      sslSocket.startHandshake();</span><br><span class="line">      <span class="comment">// block for session establishment</span></span><br><span class="line">      <span class="type">SSLSession</span> <span class="variable">sslSocketSession</span> <span class="operator">=</span> sslSocket.getSession();</span><br><span class="line">      <span class="comment">// 获取HandShake 信息</span></span><br><span class="line">      <span class="type">Handshake</span> <span class="variable">unverifiedHandshake</span> <span class="operator">=</span> Handshake.get(sslSocketSession);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Verify that the socket&#x27;s certificates are acceptable for the target host.</span></span><br><span class="line">      <span class="keyword">if</span> (!address.hostnameVerifier().verify(address.url().host(), sslSocketSession)) &#123;</span><br><span class="line">        List&lt;Certificate&gt; peerCertificates = unverifiedHandshake.peerCertificates();</span><br><span class="line">        <span class="keyword">if</span> (!peerCertificates.isEmpty()) &#123;</span><br><span class="line">          <span class="type">X509Certificate</span> <span class="variable">cert</span> <span class="operator">=</span> (X509Certificate) peerCertificates.get(<span class="number">0</span>);</span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SSLPeerUnverifiedException</span>(</span><br><span class="line">              <span class="string">&quot;Hostname &quot;</span> + address.url().host() + <span class="string">&quot; not verified:&quot;</span></span><br><span class="line">                  + <span class="string">&quot;\n    certificate: &quot;</span> + CertificatePinner.pin(cert)</span><br><span class="line">                  + <span class="string">&quot;\n    DN: &quot;</span> + cert.getSubjectDN().getName()</span><br><span class="line">                  + <span class="string">&quot;\n    subjectAltNames: &quot;</span> + OkHostnameVerifier.allSubjectAltNames(cert));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SSLPeerUnverifiedException</span>(</span><br><span class="line">              <span class="string">&quot;Hostname &quot;</span> + address.url().host() + <span class="string">&quot; not verified (no certificates)&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Check that the certificate pinner is satisfied by the certificates presented.</span></span><br><span class="line">      address.certificatePinner().check(address.url().host(),</span><br><span class="line">          unverifiedHandshake.peerCertificates());</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Success! Save the handshake and the ALPN protocol.</span></span><br><span class="line">      <span class="comment">// 成功之后，保存HandShake以及ALPN协议信息。</span></span><br><span class="line">      <span class="type">String</span> <span class="variable">maybeProtocol</span> <span class="operator">=</span> connectionSpec.supportsTlsExtensions()</span><br><span class="line">          ? Platform.get().getSelectedProtocol(sslSocket)</span><br><span class="line">          : <span class="literal">null</span>;</span><br><span class="line">      socket = sslSocket;</span><br><span class="line">      source = Okio.buffer(Okio.source(socket));</span><br><span class="line">      sink = Okio.buffer(Okio.sink(socket));</span><br><span class="line">      handshake = unverifiedHandshake;</span><br><span class="line">      protocol = maybeProtocol != <span class="literal">null</span></span><br><span class="line">          ? Protocol.get(maybeProtocol)</span><br><span class="line">          : Protocol.HTTP_1_1;</span><br><span class="line">      success = <span class="literal">true</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (AssertionError e) &#123;</span><br><span class="line">      <span class="keyword">if</span> (Util.isAndroidGetsocknameError(e)) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IOException</span>(e);</span><br><span class="line">      <span class="keyword">throw</span> e;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (sslSocket != <span class="literal">null</span>) &#123;</span><br><span class="line">        Platform.get().afterHandshake(sslSocket);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (!success) &#123;</span><br><span class="line">        closeQuietly(sslSocket);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/android/" rel="tag"># android</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2021/11/15/mmkv%E7%AE%80%E5%8D%95%E5%88%86%E6%9E%90/" rel="prev" title="mmkv简单分析">
      <i class="fa fa-chevron-left"></i> mmkv简单分析
    </a></div>
      <div class="post-nav-item">
    <a href="/2022/06/30/lint%E5%BC%80%E5%8F%91/" rel="next" title="lint开发">
      lint开发 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link"><span class="nav-number">1.</span> <span class="nav-text">RTT</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link"><span class="nav-number">1.1.</span> <span class="nav-text">TCP的RTT</span></a></li><li class="nav-item nav-level-2"><a class="nav-link"><span class="nav-number">1.2.</span> <span class="nav-text">HTTP的RTT</span></a></li><li class="nav-item nav-level-2"><a class="nav-link"><span class="nav-number">1.3.</span> <span class="nav-text">SSL 与 TLS</span></a></li><li class="nav-item nav-level-2"><a class="nav-link"><span class="nav-number">1.4.</span> <span class="nav-text">TLS 1.2的RTT</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link"><span class="nav-number">2.</span> <span class="nav-text">HTTP 1.x</span></a></li><li class="nav-item nav-level-1"><a class="nav-link"><span class="nav-number">3.</span> <span class="nav-text">HTTP 2.0</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link"><span class="nav-number">3.1.</span> <span class="nav-text">QUIC(Quick UDP Internet Connection)</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link"><span class="nav-number">3.1.1.</span> <span class="nav-text">升级困难</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link"><span class="nav-number">4.</span> <span class="nav-text">HTTP3.0</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link"><span class="nav-number">4.1.</span> <span class="nav-text">TLS 1.3</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link"><span class="nav-number">5.</span> <span class="nav-text">小结</span></a></li><li class="nav-item nav-level-1"><a class="nav-link"><span class="nav-number">6.</span> <span class="nav-text">附图</span></a></li><li class="nav-item nav-level-1"><a class="nav-link"><span class="nav-number">7.</span> <span class="nav-text">QUIC的无队头阻塞解决方案</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link"><span class="nav-number">7.1.</span> <span class="nav-text">QUIC协议</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link"><span class="nav-number">8.</span> <span class="nav-text">开启HTTP2.0</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="pacoblack"
      src="/images/avatar1.jpeg">
  <p class="site-author-name" itemprop="name">pacoblack</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">66</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">21</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">20</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/pacoblack" title="GitHub → https://github.com/pacoblack" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:pacoson.wang@gmail.com" title="E-Mail → mailto:pacoson.wang@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



      </div>
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">pacoblack</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  
  <script color='0,0,0' opacity='0.5' zIndex='-1' count='99' src="//cdn.bootcss.com/canvas-nest.js/1.0.0/canvas-nest.min.js"></script>
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

  
  <script type="text/javascript" src="//cdn.bootcss.com/canvas-nest.js/1.0.0/canvas-nest.min.js"></script>
  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer@1.10/dist/APlayer.min.css" class="aplayer-style-marker">
  <script src="https://cdn.jsdelivr.net/npm/aplayer@1.10/dist/APlayer.min.js" class="aplayer-script-marker"></script>
  <script src="https://cdn.jsdelivr.net/npm/meting@1.2/dist/Meting.min.js" class="meting-script-marker"></script>
  <div id="aplayer-AXqIDvNX"
      class="aplayer aplayer-tag-marker meting-tag-marker aplayer-fixed"
      data-id="71075946"
      data-server="netease"
      data-type="playlist"
      data-mode="circulation"
      data-autoplay="false"
      data-mutex="true"
      data-listmaxheight="340px"
      data-preload="auto"
      data-fixed="true"
      data-lrctype="0"
      data-theme="#555"></div>
<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"log":false,"model":{"jsonPath":"/live2dw/assets/Epsilon2.1.model.json"},"display":{"position":"right","width":150,"height":300},"mobile":{"show":true},"react":{"opacity":0.7}});</script></body>
</html>
