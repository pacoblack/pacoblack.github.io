<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"pacoblack.github.io","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":true,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="android测试分为：单元测试、集成测试、UI测试">
<meta property="og:type" content="article">
<meta property="og:title" content="android单元测试入门">
<meta property="og:url" content="https://pacoblack.github.io/2020/11/03/android%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95%E5%85%A5%E9%97%A8/index.html">
<meta property="og:site_name" content="我爱学习">
<meta property="og:description" content="android测试分为：单元测试、集成测试、UI测试">
<meta property="og:locale">
<meta property="og:image" content="https://developer.android.com/images/training/testing/pyramid_2x.png">
<meta property="og:image" content="https://upload-images.jianshu.io/upload_images/5955727-9a4bb263c5395f17.png">
<meta property="article:published_time" content="2020-11-03T02:24:13.000Z">
<meta property="article:modified_time" content="2021-03-13T06:56:15.512Z">
<meta property="article:author" content="pacoblack">
<meta property="article:tag" content="android">
<meta property="article:tag" content="单元测试">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://developer.android.com/images/training/testing/pyramid_2x.png">

<link rel="canonical" href="https://pacoblack.github.io/2020/11/03/android%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95%E5%85%A5%E9%97%A8/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-Hans'
  };
</script>

  <title>android单元测试入门 | 我爱学习</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">我爱学习</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">这只是一场演习</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="主页 fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="标签 fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="分类 fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="归档 fa-fw"></i>Archives</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="关于 fa-fw"></i>About</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="https://pacoblack.github.io/2020/11/03/android%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95%E5%85%A5%E9%97%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar1.jpeg">
      <meta itemprop="name" content="pacoblack">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="我爱学习">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          android单元测试入门
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-11-03 10:24:13" itemprop="dateCreated datePublished" datetime="2020-11-03T10:24:13+08:00">2020-11-03</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-03-13 14:56:15" itemprop="dateModified" datetime="2021-03-13T14:56:15+08:00">2021-03-13</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/android/" itemprop="url" rel="index"><span itemprop="name">android</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>android测试分为：单元测试、集成测试、UI测试</p>
<span id="more"></span>
<p><img src="https://developer.android.com/images/training/testing/pyramid_2x.png" alt="测试金字塔"><br>通常建议各类测试所占比例如下：小型测试占 70%，中型测试占 20%，大型测试占 10%。</p>
<h1 id="单元测试"><a href="#单元测试" class="headerlink" title="单元测试"></a>单元测试</h1><p>用于验证应用的行为，一次验证一个类。<br>此类测试旨在测试语法，异常，逻辑是否如我们所设计的一样被执行,并不能说明程序就没有错误,提前发现错误</p>
<h2 id="本地单元测试"><a href="#本地单元测试" class="headerlink" title="本地单元测试"></a>本地单元测试</h2><p>Robolectric 会模拟 Android 4.1（API 级别 16）或更高版本的运行时环境，并提供由社区维护的虚假对象（称为“影子”）。通过此功能，您可以测试依赖于框架的代码，而无需使用模拟器或模拟对象。Robolectric 支持 Android 平台的以下几个方面：</p>
<ul>
<li>组件生命周期</li>
<li>事件循环</li>
<li>所有资源</li>
</ul>
<h2 id="插桩单元测试"><a href="#插桩单元测试" class="headerlink" title="插桩单元测试"></a>插桩单元测试</h2><p>可以在物理设备或模拟器上运行插桩单元测试。不过，这种形式的测试所用的执行时间明显多于本地单元测试，因此，最好只有在必须根据实际设备硬件评估应用的行为时才依靠此方法。<br>运行插桩测试时，AndroidX Test 会使用以下线程：</p>
<ul>
<li>主线程，也称为“界面线程”或“Activity 线程”，界面交互和 Activity 生命周期事件发生在此线程上。</li>
<li>插桩线程，大多数测试都在此线程上运行。当您的测试套件开始时，AndroidJUnitTest 类将启动此线程。</li>
</ul>
<p>如果您需要在主线程上执行某个测试，请使用 @UiThreadTest 注释该测试。</p>
<h1 id="集成测试"><a href="#集成测试" class="headerlink" title="集成测试"></a>集成测试</h1><p>用于验证模块内堆栈级别之间的互动或相关模块之间的互动<br>这种测试被运行在真机或者模拟器中，用于测试你的程序真的可以正常工作。</p>
<p>您可以根据应用的结构和以下中型测试示例（按范围递增的顺序）来定义表示应用中的单元组的最佳方式：</p>
<ol>
<li>视图和视图模型之间的互动，如测试 Fragment 对象、验证布局 XML 或评估 ViewModel 对象的数据绑定逻辑。</li>
<li>应用的代码库层中的测试，验证不同数据源和数据访问对象 (DAO) 是否按预期进行互动。</li>
<li>应用的垂直切片，测试特定屏幕上的互动。此类测试目的在于验证应用堆栈的所有各层的互动。</li>
<li>多 Fragment 测试，评估应用的特定区域。与本列表中提到的其他类型的中型测试不同，这种类型的测试通常需要真实设备，因为被测互动涉及多个界面元素。</li>
</ol>
<p>如需执行这些测试，请执行以下操作：</p>
<ol>
<li>使用 Espresso-Intents 库中的方法。如需简化传入这些测试的信息，请使用虚假对象和打桩。</li>
<li>结合使用 IntentSubject 和基于 Truth 的断言来验证捕获的 intent。</li>
</ol>
<h2 id="Espresso"><a href="#Espresso" class="headerlink" title="Espresso"></a>Espresso</h2><p>当在设备或 Robolectric 上执行类似于下面的界面互动时，Espresso 有助于使任务保持同步：</p>
<ul>
<li>对 View 对象执行操作。</li>
<li>评估具有无障碍功能需求的用户如何使用您的应用。</li>
<li>找到并激活 RecyclerView 和 AdapterView 对象中的项。</li>
<li>验证传出 intent 的状态。</li>
<li>验证 WebView 对象中 DOM 的结构。</li>
</ul>
<h1 id="UI测试"><a href="#UI测试" class="headerlink" title="UI测试"></a>UI测试</h1><p>用于验证跨越了应用的多个模块的用户操作流程<br>了支持中型插桩测试之外，Espresso 还支持UI测试</p>
<h1 id="JUnit"><a href="#JUnit" class="headerlink" title="JUnit"></a>JUnit</h1><h2 id="常用注解"><a href="#常用注解" class="headerlink" title="常用注解"></a>常用注解</h2><ul>
<li>@Test<br>说明该方法是测试方法。测试方法必须是public void，可以抛出异常。</li>
<li>@Before<br>它会在每个测试方法执行前都调用一次。</li>
<li>@After<br>与@Before对应，它会在每个测试方法执行完后都调用一次。</li>
<li>@BeforeClass<br>它会在所有的测试方法执行之前调用一次。与@Before的差别是：@Before注解的方法在每个方法执行前都会调用一次，有多少个测试方法就会掉用多少次；而@BeforeClass注解的方法只会执行一次，在所有的测试方法执行前调用一次。注意该注解的测试方法必须是public static void修饰的。</li>
<li>@AfterClass<br>与@BeforeClass对应，它会在所有的测试方法执行完成后调用一次。注意该注解的测试方法必须是public static void修饰的。</li>
<li>@Ignore<br>忽略该测试方法，有时我们不想运行某个测试方法时，可以加上该注解。</li>
<li>@RunWith<br>指定该测试类使用某个运行器</li>
<li>@Parameters<br>指定测试类的测试数据集合</li>
<li>@Rule<br>重新制定测试类中方法的行为</li>
<li>@FixMethodOrder<br>指定测试类中方法的执行顺序<br>执行顺序：@BeforeClass –&gt; @Before –&gt; @Test –&gt; @After –&gt; @AfterClass</li>
</ul>
<h2 id="常用断言"><a href="#常用断言" class="headerlink" title="常用断言"></a>常用断言</h2><ul>
<li><code>assertEquals</code><br>断言传入的预期值与实际值是相等的</li>
<li><code>assertNotEquals</code><br>断言传入的预期值与实际值是不相等的</li>
<li><code>assertArrayEquals</code><br>断言传入的预期数组与实际数组是相等的</li>
<li><code>assertNull</code><br>断言传入的对象是为空</li>
<li><code>assertNotNull</code><br>断言传入的对象是不为空</li>
<li><code>assertTrue</code><br>断言条件为真</li>
<li><code>assertFalse</code><br>断言条件为假</li>
<li><code>assertSame</code><br>断言两个对象引用同一个对象，相当于“==”</li>
<li><code>assertNotSame</code><br>断言两个对象引用不同的对象，相当于“!=”</li>
<li><code>assertThat</code><br>断言实际值是否满足指定的条件</li>
</ul>
<h2 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestJUnitLifeCycle</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@BeforeClass</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;------init()------&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Before</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUp</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;------setUp()------&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@After</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">tearDown</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;------tearDown()------&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@AfterClass</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">finish</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;------finish()------&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;------test1()------&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;------test2()------&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>执行后打印结果如下：</p>
<blockquote>
<blockquote>
</blockquote>
<p>——init()——<br>——setUp()——<br>——test1()——<br>——tearDown()——<br>——setUp()——<br>——test2()——<br>——tearDown()——<br>——finish()——</p>
</blockquote>
<h2 id="Hamcrest"><a href="#Hamcrest" class="headerlink" title="Hamcrest"></a>Hamcrest</h2><p>Hamcrest是一个表达式类库，它提供了一套匹配符Matcher，且看其官网的说明：</p>
<blockquote>
<blockquote>
</blockquote>
<p>Hamcrest is a library of matchers, which can be combined in to create flexible expressions of intent in tests. They’ve also been used for other purposes.</p>
</blockquote>
<p>前面提到的那些断言方法，大家使用起来会可能会碰到一个问题：</p>
<p>断言通常必须使用一个固定的expected值，如果测试数据稍微有一点变化，测试就可能不通过，这使得测试非常脆弱。例如我们断言assertEquals(0, code)，只能判断code是不是为0，如果code不等于0则测试失败，如果code = 0或者 code = 1都是符合我的预期的呢？那又该如何测试。</p>
<p>JUnit4结合Hamcrest提供了一个全新的断言语法：assertThat，结合Hamcrest提供的匹配符，可以表达全部的测试思想，上面提到的问题也迎刃而解。<br>使用gradle引入JUnit4.12时已经包含了hamcrest-core.jar、hamcrest-library.jar、hamcrest-integration.jar这三个jar包，所以我们无需额外再单独导入hamcrest相关类库。<br>assertThat定义如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function"><span class="keyword">void</span> <span class="title">assertThat</span><span class="params">(String reason, T actual,</span></span></span><br><span class="line"><span class="params"><span class="function">            Matcher&lt;? <span class="keyword">super</span> T&gt; matcher)</span></span></span><br></pre></td></tr></table></figure>
<p>用法如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//文本</span></span><br><span class="line">assertThat(<span class="string">&quot;android studio&quot;</span>, startsWith(<span class="string">&quot;and&quot;</span>));</span><br><span class="line">assertThat(<span class="string">&quot;android studio&quot;</span>, endsWith(<span class="string">&quot;dio&quot;</span>));</span><br><span class="line">assertThat(<span class="string">&quot;android studio&quot;</span>, containsString(<span class="string">&quot;android&quot;</span>));</span><br><span class="line">assertThat(<span class="string">&quot;android studio&quot;</span>, equalToIgnoringCase(<span class="string">&quot;ANDROID studio&quot;</span>));</span><br><span class="line">assertThat(<span class="string">&quot;android studio &quot;</span>, equalToIgnoringWhiteSpace(<span class="string">&quot; android studio &quot;</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">//数字</span></span><br><span class="line"><span class="comment">//测试数字在某个范围之类，10.6在[10.5-0.2, 10.5+0.2]范围之内</span></span><br><span class="line">assertThat(<span class="number">10.6</span>, closeTo(<span class="number">10.5</span>, <span class="number">0.2</span>));</span><br><span class="line"><span class="comment">//测试数字大于某个值</span></span><br><span class="line">assertThat(<span class="number">10.6</span>, greaterThan(<span class="number">10.5</span>));</span><br><span class="line"><span class="comment">//测试数字小于某个值</span></span><br><span class="line">assertThat(<span class="number">10.6</span>, lessThan(<span class="number">11.0</span>));</span><br><span class="line"><span class="comment">//测试数字小于等于某个值</span></span><br><span class="line">assertThat(<span class="number">10.6</span>, lessThanOrEqualTo(<span class="number">10.6</span>));</span><br><span class="line"><span class="comment">//测试数字大于等于某个值</span></span><br><span class="line">assertThat(<span class="number">10.6</span>, greaterThanOrEqualTo(<span class="number">10.6</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">//集合类测试</span></span><br><span class="line">Map&lt;String, String&gt; map = <span class="keyword">new</span> HashMap&lt;String, String&gt;();</span><br><span class="line">map.put(<span class="string">&quot;a&quot;</span>, <span class="string">&quot;hello&quot;</span>);</span><br><span class="line">map.put(<span class="string">&quot;b&quot;</span>, <span class="string">&quot;world&quot;</span>);</span><br><span class="line">map.put(<span class="string">&quot;c&quot;</span>, <span class="string">&quot;haha&quot;</span>);</span><br><span class="line"><span class="comment">//测试map包含某个entry</span></span><br><span class="line">assertThat(map, hasEntry(<span class="string">&quot;a&quot;</span>, <span class="string">&quot;hello&quot;</span>));</span><br><span class="line"><span class="comment">//测试map是否包含某个key</span></span><br><span class="line">assertThat(map, hasKey(<span class="string">&quot;a&quot;</span>));</span><br><span class="line"><span class="comment">//测试map是否包含某个value</span></span><br><span class="line">assertThat(map, hasValue(<span class="string">&quot;hello&quot;</span>));</span><br><span class="line">List&lt;String&gt; list = <span class="keyword">new</span> ArrayList&lt;String&gt;();</span><br><span class="line">list.add(<span class="string">&quot;a&quot;</span>);</span><br><span class="line">list.add(<span class="string">&quot;b&quot;</span>);</span><br><span class="line">list.add(<span class="string">&quot;c&quot;</span>);</span><br><span class="line"><span class="comment">//测试list是否包含某个item</span></span><br><span class="line">assertThat(list, hasItem(<span class="string">&quot;a&quot;</span>));</span><br><span class="line">assertThat(list, hasItems(<span class="string">&quot;a&quot;</span>, <span class="string">&quot;b&quot;</span>));</span><br><span class="line"><span class="comment">//测试数组是否包含某个item</span></span><br><span class="line">String[] array = <span class="keyword">new</span> String[]&#123;<span class="string">&quot;a&quot;</span>, <span class="string">&quot;b&quot;</span>, <span class="string">&quot;c&quot;</span>, <span class="string">&quot;d&quot;</span>&#125;;</span><br><span class="line">assertThat(array, hasItemInArray(<span class="string">&quot;a&quot;</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">//测试对象</span></span><br><span class="line"><span class="comment">//测试对象不为null</span></span><br><span class="line">assertThat(<span class="keyword">new</span> Object(), notNullValue());</span><br><span class="line">Object obj = <span class="keyword">null</span>;</span><br><span class="line"><span class="comment">//测试对象为null</span></span><br><span class="line">assertThat(obj, nullValue());</span><br><span class="line">String str = <span class="keyword">null</span>;</span><br><span class="line">assertThat(str, nullValue(String.class));</span><br><span class="line">obj = <span class="keyword">new</span> Object();</span><br><span class="line">Object obj2 = obj;</span><br><span class="line"><span class="comment">//测试2个引用是否指向的通一个对象</span></span><br><span class="line">assertThat(obj, sameInstance(obj2));</span><br><span class="line">str = <span class="string">&quot;abc&quot;</span>;</span><br><span class="line">assertThat(str, instanceOf(String.class));</span><br><span class="line"></span><br><span class="line"><span class="comment">//测试JavaBean对象是否有某个属性</span></span><br><span class="line">assertThat(<span class="keyword">new</span> UserInfo(), hasProperty(<span class="string">&quot;name&quot;</span>));</span><br><span class="line">assertThat(<span class="keyword">new</span> UserInfo(), hasProperty(<span class="string">&quot;age&quot;</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">//-------组合逻辑测试--------</span></span><br><span class="line"><span class="comment">//两者都满足，a &amp;&amp; b</span></span><br><span class="line">assertThat(<span class="number">10.4</span>, both(greaterThan(<span class="number">10.0</span>)).and(lessThan(<span class="number">10.5</span>)));</span><br><span class="line"><span class="comment">//所有的条件都满足，a &amp;&amp; b &amp;&amp; c...</span></span><br><span class="line">assertThat(<span class="number">10.4</span>, allOf(greaterThan(<span class="number">10.0</span>), lessThan(<span class="number">10.5</span>)));</span><br><span class="line"><span class="comment">//任一条件满足，a || b || c...</span></span><br><span class="line">assertThat(<span class="number">10.4</span>, anyOf(greaterThan(<span class="number">10.3</span>), lessThan(<span class="number">10.4</span>)));</span><br><span class="line"><span class="comment">//两者满足一个即可，a || b</span></span><br><span class="line">assertThat(<span class="number">10.4</span>, either(greaterThan(<span class="number">10.0</span>)).or(lessThan(<span class="number">10.2</span>)));</span><br><span class="line">assertThat(<span class="number">10.4</span>, is(<span class="number">10.4</span>));</span><br><span class="line">assertThat(<span class="number">10.4</span>, is(equalTo(<span class="number">10.4</span>)));</span><br><span class="line">assertThat(<span class="number">10.4</span>, is(greaterThan(<span class="number">10.3</span>)));</span><br><span class="line">str = <span class="keyword">new</span> String(<span class="string">&quot;abc&quot;</span>);</span><br><span class="line">assertThat(str, is(instanceOf(String.class)));</span><br><span class="line">assertThat(str, isA(String.class));</span><br><span class="line">assertThat(<span class="number">10.4</span>, not(<span class="number">10.5</span>));</span><br><span class="line">assertThat(str, not(<span class="string">&quot;abcd&quot;</span>));</span><br><span class="line"></span><br><span class="line">assertThat(str, any(String.class));</span><br><span class="line">assertThat(str, anything());</span><br></pre></td></tr></table></figure>

<h2 id="Test-Runners"><a href="#Test-Runners" class="headerlink" title="Test Runners"></a>Test Runners</h2><p>JUnit没有main()方法，那它是怎么开始执行的呢？众所周知，不管是什么程序，都必须有一个程序执行入口，而这个入口通常是main()方法。显然，JUnit能直接执行某个测试方法，那么它肯定会有一个程序执行入口。没错，其实在org.junit.runner包下，有个JUnitCore.java类，这个类有一个标准的main()方法，这个其实就是JUnit程序的执行入口，其代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String... args)</span> </span>&#123;</span><br><span class="line">    Result result = <span class="keyword">new</span> JUnitCore().runMain(<span class="keyword">new</span> RealSystem(), args);</span><br><span class="line">    System.exit(result.wasSuccessful() ? <span class="number">0</span> : <span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过分析里面的runMain()方法，可以找到最终的执行代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Result <span class="title">run</span><span class="params">(Runner runner)</span> </span>&#123;</span><br><span class="line">    Result result = <span class="keyword">new</span> Result();</span><br><span class="line">    RunListener listener = result.createListener();</span><br><span class="line">    notifier.addFirstListener(listener);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        notifier.fireTestRunStarted(runner.getDescription());</span><br><span class="line">        runner.run(notifier);</span><br><span class="line">        notifier.fireTestRunFinished(result);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        removeListener(listener);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到，所有的单元测试方法都是通过Runner来执行的。Runner只是一个抽象类，它是用来跑测试用例并通知结果的，JUnit提供了很多Runner的实现类，可以根据不同的情况选择不同的test runner。<br>通过@RunWith注解，可以为我们的测试用例选定一个特定的Runner来执行。</p>
<ul>
<li>默认的test runner是 BlockJUnit4ClassRunner。</li>
<li>@RunWith(JUnit4.class)，使用的依然是默认的test runner，实质上JUnit4继承自BlockJUnit4ClassRunner。</li>
</ul>
<h2 id="Suite"><a href="#Suite" class="headerlink" title="Suite"></a>Suite</h2><p>Suite翻译过来是测试套件，意思是让我们将一批其他的测试类聚集在一起，然后一起执行，这样就达到了同时运行多个测试类的目的。</p>
<p>假设我们有3个测试类：TestLogin, TestLogout, TestUpdate，使用Suite编写一个TestSuite类，我们可以将这3个测试类组合起来一起执行。TestSuite类代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RunWith(Suite.class)</span></span><br><span class="line"><span class="meta">@Suite</span>.SuiteClasses(&#123;</span><br><span class="line">        TestLogin.class,</span><br><span class="line">        TestLogout.class,</span><br><span class="line">        TestUpdate.class</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestSuite</span> </span>&#123;</span><br><span class="line">    <span class="comment">//不需要有任何实现方法</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>执行运行TestSuite，相当于同时执行了这3个测试类。<br>Suite还可以进行嵌套，即一个测试Suite里包含另外一个测试Suite。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RunWith(Suite.class)</span></span><br><span class="line"><span class="meta">@Suite</span>.SuiteClasses(TestSuite.class)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestSuite2</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Rule"><a href="#Rule" class="headerlink" title="Rule"></a>Rule</h2><p>@Rule是JUnit4的新特性，它能够灵活地扩展每个测试方法的行为，为他们提供一些额外的功能。下面是JUnit提供的一些基础的的test rule，所有的rule都实现了TestRule这个接口类。除此外，可以自定义test rule。</p>
<h3 id="TestName-Rule"><a href="#TestName-Rule" class="headerlink" title="TestName Rule"></a>TestName Rule</h3><p>在测试方法内部能知道当前的方法名。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NameRuleTest</span> </span>&#123;</span><br><span class="line">   <span class="comment">//用@Rule注解来标记一个TestRule，注意必须是public修饰的</span></span><br><span class="line">  <span class="meta">@Rule</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">final</span> TestName name = <span class="keyword">new</span> TestName();</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Test</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testA</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    assertEquals(<span class="string">&quot;testA&quot;</span>, name.getMethodName());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Test</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testB</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    assertEquals(<span class="string">&quot;testB&quot;</span>, name.getMethodName());</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Timeout-Rule"><a href="#Timeout-Rule" class="headerlink" title="Timeout Rule"></a>Timeout Rule</h3><p>与@Test注解里的属性timeout类似，但这里是针对同一测试类里的所有测试方法都使用同样的超时时间。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TimeoutRuleTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Rule</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> Timeout globalTimeout = Timeout.millis(<span class="number">20</span>);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testInfiniteLoop1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span>(;;) &#123;...&#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testInfiniteLoop2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span>(;;) &#123;...&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="ExpectedException-Rules"><a href="#ExpectedException-Rules" class="headerlink" title="ExpectedException Rules"></a>ExpectedException Rules</h3><p>与@Test的属性expected作用类似，用来测试异常，但是它更灵活方便。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExpectedExceptionTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Rule</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> ExpectedException exception = ExpectedException.none();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//不抛出任何异常</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">throwsNothing</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//抛出指定的异常</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">throwsIndexOutOfBoundsException</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        exception.expect(IndexOutOfBoundsException.class);</span><br><span class="line">        <span class="keyword">new</span> ArrayList&lt;String&gt;().get(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">throwsNullPointerException</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        exception.expect(NullPointerException.class);</span><br><span class="line">        exception.expectMessage(startsWith(<span class="string">&quot;null pointer&quot;</span>));</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">&quot;null pointer......oh my god.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="TemporaryFolder-Rule"><a href="#TemporaryFolder-Rule" class="headerlink" title="TemporaryFolder Rule"></a>TemporaryFolder Rule</h3><p>该rule能够创建文件以及文件夹，并且在测试方法结束的时候自动删除掉创建的文件，无论测试通过或者失败。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TemporaryFolderTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Rule</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> TemporaryFolder folder = <span class="keyword">new</span> TemporaryFolder();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> File file;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Before</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUp</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        file = folder.newFile(<span class="string">&quot;test.txt&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testFileCreation</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;testFileCreation file exists : &quot;</span> + file.exists());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@After</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">tearDown</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;tearDown file exists : &quot;</span> + file.exists());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@AfterClass</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">finish</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;finish file exists : &quot;</span> + file.exists());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>测试执行后打印结果如下：</p>
<blockquote>
<blockquote>
</blockquote>
<p>testFileCreation file exists : true<br>tearDown file exists : true<br>finish file exists : false    //说明最后文件被删除掉了</p>
</blockquote>
<h3 id="ExternalResource-Rules"><a href="#ExternalResource-Rules" class="headerlink" title="ExternalResource Rules"></a>ExternalResource Rules</h3><p>实现了类似@Before、@After注解提供的功能，能在方法执行前与结束后做一些额外的操作。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserExternalTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Rule</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> ExternalResource externalResource = <span class="keyword">new</span> ExternalResource() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">after</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">super</span>.after();</span><br><span class="line">            System.out.println(<span class="string">&quot;---after---&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">before</span><span class="params">()</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">            <span class="keyword">super</span>.before();</span><br><span class="line">            System.out.println(<span class="string">&quot;---before---&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testMethod</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;---test method---&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>执行后打印结果如下：</p>
<blockquote>
<blockquote>
</blockquote>
<p>—before—<br>—test method—<br>—after—</p>
</blockquote>
<h3 id="Custom-Rule"><a href="#Custom-Rule" class="headerlink" title="Custom Rule"></a>Custom Rule</h3><p>假如我们一直需要某些提示，那是不是需要每次在测试类中去实现它。这样就会比较麻烦。这时你就可以使用@Rule来解决这个问题，它甚至比@Before与@After还要强大。<br>自定义@Rule很简单，就是实现TestRule 接口，实现apply方法。代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RepeatRule</span> <span class="keyword">implements</span> <span class="title">TestRule</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//这里定义一个注解，用于动态在测试方法里指定重复次数</span></span><br><span class="line">    <span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line">    <span class="meta">@Target(&#123;ElementType.METHOD&#125;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="meta">@interface</span> Repeat &#123;</span><br><span class="line">        <span class="function"><span class="keyword">int</span> <span class="title">count</span><span class="params">()</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Statement <span class="title">apply</span><span class="params">(<span class="keyword">final</span> Statement base, <span class="keyword">final</span> Description description)</span> </span>&#123;</span><br><span class="line">        Statement repeatStatement =  <span class="keyword">new</span> Statement() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">evaluate</span><span class="params">()</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">                Repeat repeat = description.getAnnotation(Repeat.class);</span><br><span class="line">                <span class="comment">//如果有@Repeat注解，则会重复执行指定次数</span></span><br><span class="line">                <span class="keyword">if</span>(repeat != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>; i &lt; repeat.count(); i++) &#123;</span><br><span class="line">                        base.evaluate();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">//如果没有注解，则不会重复执行</span></span><br><span class="line">                    base.evaluate();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">return</span> repeatStatement;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后使用这个Rule:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RepeatTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Rule</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> RepeatRule repeatRule = <span class="keyword">new</span> RepeatRule();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//该方法重复执行5次</span></span><br><span class="line">    <span class="meta">@RepeatRule</span>.Repeat(count = <span class="number">5</span>)</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testMethod</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;---test method---&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testMethod2</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;---test method2---&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>执行结果如下：</p>
<blockquote>
<blockquote>
</blockquote>
<p>—test method2—<br>—test method—<br>—test method—<br>—test method—<br>—test method—<br>—test method—</p>
</blockquote>
<h1 id="Mockito"><a href="#Mockito" class="headerlink" title="Mockito"></a>Mockito</h1><p>在写单元测试的时候，我们会遇到某个测试类有很多依赖，这些依赖类或对象又有别的依赖，这样会形成一棵巨大的依赖树，要在单元测试的环境中完整地构建这样的依赖，是及其困难的，有时候甚至因为运行环境的关系，几乎不可能完整地构建出这些依赖。如下图所示：<br><img src="https://upload-images.jianshu.io/upload_images/5955727-9a4bb263c5395f17.png" alt="依赖"><br>Mockito框架就是为了解决这个问题而设计的。</p>
<h2 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testMock</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//创建一个mock对象</span></span><br><span class="line">    List list = mock(List.class);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//使用mock对象</span></span><br><span class="line">    list.add(<span class="string">&quot;one&quot;</span>);</span><br><span class="line">    list.clear();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//验证mock对象的行为</span></span><br><span class="line">    verify(list).add(<span class="string">&quot;one&quot;</span>);  <span class="comment">//验证有add(&quot;one&quot;)行为发生</span></span><br><span class="line">    verify(list).clear();          <span class="comment">//验证有clear()行为发生</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Stubbing"><a href="#Stubbing" class="headerlink" title="Stubbing"></a>Stubbing</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testMock2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//不仅可以针对接口mock, 还可以针对具体类</span></span><br><span class="line">    LinkedList list = mock(LinkedList.class);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//设置返回值，当调用list.get(0)时会返回&quot;first&quot;</span></span><br><span class="line">    when(list.get(<span class="number">0</span>)).thenReturn(<span class="string">&quot;first&quot;</span>);</span><br><span class="line">    <span class="comment">//当调用list.get(1)时会抛出异常</span></span><br><span class="line">    when(list.get(<span class="number">1</span>)).thenThrow(<span class="keyword">new</span> RuntimeException());</span><br><span class="line"></span><br><span class="line">    <span class="comment">//会打印&quot;print&quot;</span></span><br><span class="line">    System.out.println(list.get(<span class="number">0</span>));</span><br><span class="line">    <span class="comment">//会抛出RuntimeException</span></span><br><span class="line">    System.out.println(list.get(<span class="number">1</span>));</span><br><span class="line">    <span class="comment">//会打印 null</span></span><br><span class="line">    System.out.println(list.get(<span class="number">99</span>));</span><br><span class="line"></span><br><span class="line">    verify(list).get(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Argument-Matchers"><a href="#Argument-Matchers" class="headerlink" title="Argument Matchers"></a>Argument Matchers</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testMock3</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    List list = mock(List.class);</span><br><span class="line">    <span class="comment">//使用anyInt(), anyString(), anyLong()等进行参数匹配</span></span><br><span class="line">    when(list.get(anyInt())).thenReturn(<span class="string">&quot;item&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//将会打印出&quot;item&quot;</span></span><br><span class="line">    System.out.println(list.get(<span class="number">100</span>));</span><br><span class="line"></span><br><span class="line">    verify(list).get(anyInt());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="验证调用次数"><a href="#验证调用次数" class="headerlink" title="验证调用次数"></a>验证调用次数</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testMock4</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    List list = mock(List.class);</span><br><span class="line">    list.add(<span class="string">&quot;once&quot;</span>);</span><br><span class="line">    list.add(<span class="string">&quot;twice&quot;</span>);</span><br><span class="line">    list.add(<span class="string">&quot;twice&quot;</span>);</span><br><span class="line">    list.add(<span class="string">&quot;triple&quot;</span>);</span><br><span class="line">    list.add(<span class="string">&quot;triple&quot;</span>);</span><br><span class="line">    list.add(<span class="string">&quot;triple&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//执行1次</span></span><br><span class="line">    verify(list, times(<span class="number">1</span>)).add(<span class="string">&quot;once&quot;</span>);</span><br><span class="line">    <span class="comment">//执行2次</span></span><br><span class="line">    verify(list, times(<span class="number">2</span>)).add(<span class="string">&quot;twice&quot;</span>);</span><br><span class="line">    verify(list, times(<span class="number">3</span>)).add(<span class="string">&quot;triple&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//从不执行, never()等同于times(0)</span></span><br><span class="line">    verify(list, never()).add(<span class="string">&quot;never happened&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//验证至少执行1次</span></span><br><span class="line">    verify(list, atLeastOnce()).add(<span class="string">&quot;twice&quot;</span>);</span><br><span class="line">    <span class="comment">//验证至少执行2次</span></span><br><span class="line">    verify(list, atLeast(<span class="number">2</span>)).add(<span class="string">&quot;twice&quot;</span>);</span><br><span class="line">    <span class="comment">//验证最多执行4次</span></span><br><span class="line">    verify(list, atMost(<span class="number">4</span>)).add(<span class="string">&quot;triple&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="spy"><a href="#spy" class="headerlink" title="spy"></a>spy</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testMock10</span><span class="params">()</span></span>&#123;</span><br><span class="line">    List list = <span class="keyword">new</span> ArrayList();</span><br><span class="line">    List spy = spy(list);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//subbing方法，size()并不会真实调用，这里返回10</span></span><br><span class="line">    when(spy.size()).thenReturn(<span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//使用spy对象会调用真实的方法</span></span><br><span class="line">    spy.add(<span class="string">&quot;one&quot;</span>);</span><br><span class="line">    spy.add(<span class="string">&quot;two&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//会打印出&quot;one&quot;</span></span><br><span class="line">    System.out.println(spy.get(<span class="number">0</span>));</span><br><span class="line">    <span class="comment">//会打印出&quot;10&quot;，与前面的stubbing方法对应</span></span><br><span class="line">    System.out.println(spy.size());</span><br><span class="line"></span><br><span class="line">    <span class="comment">//对spy对象依旧可以来验证其行为</span></span><br><span class="line">    verify(spy).add(<span class="string">&quot;one&quot;</span>);</span><br><span class="line">    verify(spy).add(<span class="string">&quot;two&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="Robolectric"><a href="#Robolectric" class="headerlink" title="Robolectric"></a>Robolectric</h1><p>Android程序员都知道，在Android模拟器或者真机设备上运行测试是很慢的。执行一次测试需要编译、部署、启动app等一系列步骤，往往需要花几分钟或者更久的时间。<br>Robolectric框架就可解决这个问题，它实现了一套JVM能运行的Android SDK，从而能够脱离Android环境进行测试，将原来运行一次测试的时间从几分钟缩短到几秒钟。</p>
<ol>
<li>基础设置<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//这里版本已经很旧了，看个意思</span></span><br><span class="line">testCompile <span class="string">&quot;org.robolectric:robolectric:3.3.2&quot;</span></span><br><span class="line">testCompile <span class="string">&#x27;org.robolectric:shadows-support-v4:3.3.2&#x27;</span></span><br><span class="line">testCompile <span class="string">&#x27;org.robolectric:shadows-multidex:3.3.2&#x27;</span></span><br></pre></td></tr></table></figure></li>
<li>添加test runner<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RunWith(RobolectricTestRunner.class)</span></span><br><span class="line"><span class="meta">@Config(constants = BuildConfig.class, sdk = 23)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RobolectricSampleActivityTest</span> </span>&#123;</span><br><span class="line">    <span class="comment">//必须指定test runner为RobolectricTestRunner</span></span><br><span class="line">    <span class="comment">//通过@Config注解来配置运行参数</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>android studio 3.0 注意<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">android &#123;</span><br><span class="line">  testOptions &#123;</span><br><span class="line">    unitTests &#123;</span><br><span class="line">      includeAndroidResources = <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="测试生命周期"><a href="#测试生命周期" class="headerlink" title="测试生命周期"></a>测试生命周期</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">Activity</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    Button mBtn;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line"></span><br><span class="line">        mBtn = (Button) findViewById(R.id.btn_main);</span><br><span class="line">        mBtn.setText(<span class="string">&quot;onCreate&quot;</span>);</span><br><span class="line">        mBtn.setOnClickListener(<span class="keyword">new</span> View.OnClickListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</span><br><span class="line">                Intent intent = <span class="keyword">new</span> Intent(MainActivity.<span class="keyword">this</span>, RobolectricSampleActivity.class);</span><br><span class="line">                startActivity(intent);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onStart</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onStart();</span><br><span class="line">        mBtn.setText(<span class="string">&quot;onStart&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onResume</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onResume();</span><br><span class="line">        mBtn.setText(<span class="string">&quot;onResume&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onPause</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onPause();</span><br><span class="line">        mBtn.setText(<span class="string">&quot;onPause&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onStop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onStop();</span><br><span class="line">        mBtn.setText(<span class="string">&quot;onStop&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onDestroy();</span><br><span class="line">        mBtn.setText(<span class="string">&quot;onDestroy&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
测试代码如下：<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testActivityLifeCycle</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    ActivityController&lt;MainActivity&gt; controller = Robolectric.buildActivity(MainActivity.class);</span><br><span class="line">    <span class="comment">//会调用Activity的onCreate()方法</span></span><br><span class="line">    controller.create();</span><br><span class="line">    Button btn = (Button) controller.get().findViewById(R.id.btn_main);</span><br><span class="line">    System.out.println(btn.getText().toString());</span><br><span class="line">    controller.start();</span><br><span class="line">    System.out.println(btn.getText().toString());</span><br><span class="line">    controller.resume();</span><br><span class="line">    System.out.println(btn.getText().toString());</span><br><span class="line">    controller.pause();</span><br><span class="line">    System.out.println(btn.getText().toString());</span><br><span class="line">    controller.stop();</span><br><span class="line">    System.out.println(btn.getText().toString());</span><br><span class="line">    controller.destroy();</span><br><span class="line">    System.out.println(btn.getText().toString());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
控制台打印结果如下所示：<blockquote>
<blockquote>
</blockquote>
<p>onCreate<br>onStart<br>onResume<br>onPause<br>onStop<br>onDestroy</p>
</blockquote>
</li>
</ol>
<h2 id="测试Toast"><a href="#测试Toast" class="headerlink" title="测试Toast"></a>测试Toast</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//点击button弹出toast信息</span></span><br><span class="line">mBtn.setOnClickListener(<span class="keyword">new</span> View.OnClickListener() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</span><br><span class="line">        Toast.makeText(MainActivity.<span class="keyword">this</span>, <span class="string">&quot;toast sample&quot;</span>, Toast.LENGTH_SHORT).show();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>测试代码如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testToast</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    MainActivity activity = Robolectric.setupActivity(MainActivity.class);</span><br><span class="line">    Button btn = (Button) activity.findViewById(R.id.btn_main);</span><br><span class="line">    btn.performClick();</span><br><span class="line">    Assert.assertNotNull(ShadowToast.getLatestToast());</span><br><span class="line">    Assert.assertEquals(<span class="string">&quot;toast sample&quot;</span>, ShadowToast.getTextOfLatestToast());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="测试Dialog"><a href="#测试Dialog" class="headerlink" title="测试Dialog"></a>测试Dialog</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testDialog</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    MainActivity activity = Robolectric.setupActivity(MainActivity.class);</span><br><span class="line">    Button btn = (Button) activity.findViewById(R.id.btn_main);</span><br><span class="line">    btn.performClick();</span><br><span class="line">    Assert.assertNotNull(ShadowAlertDialog.getLatestAlertDialog());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="测试资源文件"><a href="#测试资源文件" class="headerlink" title="测试资源文件"></a>测试资源文件</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testApplication</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Application app = RuntimeEnvironment.application;</span><br><span class="line">    Context shadow = ShadowApplication.getInstance().getApplicationContext();</span><br><span class="line">    Assert.assertSame(shadow, app);     </span><br><span class="line">    System.out.println(shadow.getResources().getString(R.string.app_name));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="测试Fragment"><a href="#测试Fragment" class="headerlink" title="测试Fragment"></a>测试Fragment</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testFragment</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    TestFragment fragment = <span class="keyword">new</span> TestFragment();</span><br><span class="line">    <span class="comment">//该方法会添加Fragment到Activity中</span></span><br><span class="line">    SupportFragmentTestUtil.startFragment(fragment);</span><br><span class="line">    Assert.assertThat(fragment.getView(), CoreMatchers.notNullValue());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="异步代码测试"><a href="#异步代码测试" class="headerlink" title="异步代码测试"></a>异步代码测试</h1><p>当我们想要测试如下代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DataManager</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">OnDataListener</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSuccess</span><span class="params">(List&lt;String&gt; dataList)</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFail</span><span class="params">()</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">loadData</span><span class="params">(<span class="keyword">final</span> OnDataListener listener)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Thread.sleep(<span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line">                    List&lt;String&gt; dataList = <span class="keyword">new</span> ArrayList&lt;String&gt;();</span><br><span class="line">                    dataList.add(<span class="string">&quot;11&quot;</span>);</span><br><span class="line">                    dataList.add(<span class="string">&quot;22&quot;</span>);</span><br><span class="line">                    dataList.add(<span class="string">&quot;33&quot;</span>);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span>(listener != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        listener.onSuccess(dataList);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                    <span class="keyword">if</span>(listener != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        listener.onFail();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>使用CountDownLatch<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testGetData</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   <span class="keyword">final</span> List&lt;String&gt; list = <span class="keyword">new</span> ArrayList&lt;String&gt;();</span><br><span class="line">   DataManager dataManager = <span class="keyword">new</span> DataManager();</span><br><span class="line">   <span class="keyword">final</span> CountDownLatch latch = <span class="keyword">new</span> CountDownLatch(<span class="number">1</span>);</span><br><span class="line">   dataManager.loadData(<span class="keyword">new</span> DataManager.OnDataListener() &#123;</span><br><span class="line">       <span class="meta">@Override</span></span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSuccess</span><span class="params">(List&lt;String&gt; dataList)</span> </span>&#123;</span><br><span class="line">           <span class="keyword">if</span>(dataList != <span class="keyword">null</span>) &#123;</span><br><span class="line">               list.addAll(dataList);</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="comment">//callback方法执行完毕侯，唤醒测试方法执行线程</span></span><br><span class="line">           latch.countDown();</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="meta">@Override</span></span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFail</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;);</span><br><span class="line">   <span class="keyword">try</span> &#123;</span><br><span class="line">       <span class="comment">//测试方法线程会在这里暂停, 直到loadData()方法执行完毕, 才会被唤醒继续执行</span></span><br><span class="line">       latch.await();</span><br><span class="line">   &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">       e.printStackTrace();</span><br><span class="line">   &#125;</span><br><span class="line">   Assert.assertEquals(<span class="number">3</span>, list.size());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
或者<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testGetData</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> List&lt;String&gt; list = <span class="keyword">new</span> ArrayList&lt;String&gt;();</span><br><span class="line">    DataManager dataManager = <span class="keyword">new</span> DataManager();</span><br><span class="line">    <span class="keyword">final</span> Object lock = <span class="keyword">new</span> Object();</span><br><span class="line">    dataManager.loadData(<span class="keyword">new</span> DataManager.OnDataListener() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSuccess</span><span class="params">(List&lt;String&gt; dataList)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span>(dataList != <span class="keyword">null</span>) &#123;</span><br><span class="line">                list.addAll(dataList);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">synchronized</span> (lock) &#123;</span><br><span class="line">                lock.notify();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFail</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (lock) &#123;</span><br><span class="line">            lock.wait();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    Assert.assertEquals(<span class="number">3</span>, list.size());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>将异步变成同步<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Before</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setup</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    RxJavaPlugins.reset();</span><br><span class="line">    <span class="comment">//设置Schedulers.io()返回的线程</span></span><br><span class="line">    RxJavaPlugins.setIoSchedulerHandler(<span class="keyword">new</span> Function&lt;Scheduler, Scheduler&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Scheduler <span class="title">apply</span><span class="params">(Scheduler scheduler)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">            <span class="comment">//返回当前的工作线程，这样测试方法与之都是运行在同一个线程了，从而实现异步变同步。</span></span><br><span class="line">            <span class="keyword">return</span> Schedulers.trampoline();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testGetDataAsync</span><span class="params">()</span> </span>&#123;    </span><br><span class="line">    <span class="keyword">final</span> List&lt;String&gt; list = <span class="keyword">new</span> ArrayList&lt;String&gt;();</span><br><span class="line">    DataManager dataManager = <span class="keyword">new</span> DataManager();</span><br><span class="line">    dataManager.loadData().subscribe(<span class="keyword">new</span> Consumer&lt;List&lt;String&gt;&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">accept</span><span class="params">(List&lt;String&gt; dataList)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">            <span class="keyword">if</span>(dataList != <span class="keyword">null</span>) &#123;</span><br><span class="line">                list.addAll(dataList);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, <span class="keyword">new</span> Consumer&lt;Throwable&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">accept</span><span class="params">(Throwable throwable)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    Assert.assertEquals(<span class="number">3</span>, list.size());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<h1 id="Espresso-1"><a href="#Espresso-1" class="headerlink" title="Espresso"></a>Espresso</h1><h2 id="依赖库"><a href="#依赖库" class="headerlink" title="依赖库"></a>依赖库</h2><blockquote>
<blockquote>
</blockquote>
<p>espresso-core 包含基础的视图匹配器，操作和断言库<br>espresso-web 包含webview的测试库<br>espresso-idling-resource 包含和后台作业的同步的机制<br>espresso-contrib 包括DatePicker, RecyclerView and Drawer actions, accessibility checks, and CountingIdlingResource这些的扩展库<br>espresso-intent 包括与意图有关的测试库<br>espresso-remote Espresso多处理功能的位置</p>
</blockquote>
<h2 id="基础配置"><a href="#基础配置" class="headerlink" title="基础配置"></a>基础配置</h2><p>在app/build.gradle文件中添加依赖</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">androidTestImplementation &#x27;androidx.test.espresso:espresso-core:3.2.0&#x27;</span><br><span class="line">androidTestImplementation &#x27;androidx.test:runner:1.2.0&#x27;</span><br><span class="line">androidTestImplementation &#x27;androidx.test:rules:1.2.0&#x27;</span><br></pre></td></tr></table></figure>
<p>在app/build.gradle文件中的android.defaultConfig中添加</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">testInstrumentationRunner &quot;androidx.test.runner.AndroidJUnitRunner&quot;</span><br></pre></td></tr></table></figure>
<p>注意：上面的依赖只能实现基本功能，如果你想使用所有的功能，则按下面的配置：<br>所有依赖</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">androidTestImplementation &#x27;androidx.test.ext:junit:1.1.1&#x27;</span><br><span class="line">androidTestImplementation &#x27;androidx.test.ext:truth:1.2.0&#x27;</span><br><span class="line">androidTestImplementation &#x27;androidx.test.espresso:espresso-core:3.2.0&#x27;</span><br><span class="line">androidTestImplementation &#x27;androidx.test.espresso:espresso-contrib:3.2.0&#x27;</span><br><span class="line">androidTestImplementation &#x27;androidx.test:runner:1.2.0&#x27;</span><br><span class="line">androidTestImplementation &#x27;androidx.test:rules:1.2.0&#x27;</span><br><span class="line">androidTestImplementation &#x27;androidx.test.espresso:espresso-intents:3.2.0&#x27;</span><br><span class="line">implementation &#x27;androidx.recyclerview:recyclerview:1.1.0&#x27;</span><br><span class="line">implementation &#x27;androidx.test.espresso:espresso-idling-resource:3.2.0&#x27;</span><br></pre></td></tr></table></figure>

<h2 id="API组件"><a href="#API组件" class="headerlink" title="API组件"></a>API组件</h2><p>Espresso 的主要组件包括：</p>
<ul>
<li>Espresso - 用于与视图交互（通过 onView() 和 onData()）的入口点。此外，还公开不一定与任何视图相关联的 API，如 pressBack()。</li>
<li>ViewMatchers - 实现 Matcher&lt;? super View&gt; 接口的对象的集合。您可以将其中一个或多个对象传递给 onView() 方法，以在当前视图层次结构中找到某个视图。</li>
<li>ViewActions - 可以传递给 ViewInteraction.perform() 方法的 ViewAction 对象的集合，例如 click()。</li>
<li>ViewAssertions - 可以通过 ViewInteraction.check() 方法传递的 ViewAssertion 对象的集合。在大多数情况下，您将使用 matches 断言，它使用视图匹配器断言当前选定视图的状态。<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// withId(R.id.my_view) is a ViewMatcher</span></span><br><span class="line"><span class="comment">// click() is a ViewAction</span></span><br><span class="line"><span class="comment">// matches(isDisplayed()) is a ViewAssertion</span></span><br><span class="line">onView(withId(R.id.my_view))</span><br><span class="line">    .perform(click())</span><br><span class="line">    .check(matches(isDisplayed()));</span><br></pre></td></tr></table></figure>
更直观一点的：<br><embed width="100%" height="900px" src="https://android.github.io/android-test/downloads/espresso-cheat-sheet-2.1.0.pdf"></li>
</ul>
<h3 id="查找视图"><a href="#查找视图" class="headerlink" title="查找视图"></a>查找视图</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">onView(withId(R.id.my_view));</span><br><span class="line"></span><br><span class="line">onView(allOf(withId(R.id.my_view), withText(<span class="string">&quot;Hello!&quot;</span>)));</span><br><span class="line"></span><br><span class="line">onView(allOf(withId(R.id.my_view), not(withText(<span class="string">&quot;Unwanted&quot;</span>))));</span><br></pre></td></tr></table></figure>
<h3 id="操作视图"><a href="#操作视图" class="headerlink" title="操作视图"></a>操作视图</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">onView(...).perform(click());</span><br><span class="line"><span class="comment">//perform 调用来执行多项操作</span></span><br><span class="line">onView(...).perform(typeText(<span class="string">&quot;Hello&quot;</span>), click());</span><br><span class="line"><span class="comment">//视图位于 ScrollView（垂直或水平）内</span></span><br><span class="line">onView(...).perform(scrollTo(), click());</span><br></pre></td></tr></table></figure>
<h3 id="检查断言"><a href="#检查断言" class="headerlink" title="检查断言"></a>检查断言</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">onView(...).check(matches(withText(<span class="string">&quot;Hello!&quot;</span>)));</span><br><span class="line"></span><br><span class="line"><span class="comment">// 先去匹配非唯一视图，然后使用hasSibling()匹配器缩小选择范围。</span></span><br><span class="line">onView(allOf(withText(<span class="number">7</span>), hasSibling(withText(<span class="string">&quot;item: 0&quot;</span>)))).perform(click());</span><br><span class="line"></span><br><span class="line"><span class="comment">//匹配Actionbar正常的操作栏里边的视图</span></span><br><span class="line">openActionBarOverflowOrOptionsMenu(getInstrumentation().getTargetContext());</span><br><span class="line">onView(withText(<span class="string">&quot;World&quot;</span>)).perform(click());</span><br><span class="line"></span><br><span class="line"><span class="comment">//匹配Actionbar上下文相关的操作栏里边的视图</span></span><br><span class="line">openContexturlActionModeOverflowMenu();</span><br><span class="line">onView(withText(<span class="string">&quot;Hello&quot;</span>)).perform(click());</span><br><span class="line"></span><br><span class="line"><span class="comment">//断言view是否显示</span></span><br><span class="line">onView(withId(R.id.test)).check(matches(not(isDisplayed())));</span><br><span class="line"></span><br><span class="line"><span class="comment">//断言view是否存在</span></span><br><span class="line">onView(withId(R.id.test)).check(doesNotExist());</span><br></pre></td></tr></table></figure>

<h3 id="自定义断言"><a href="#自定义断言" class="headerlink" title="自定义断言"></a>自定义断言</h3><h4 id="自定义故障处理程序"><a href="#自定义故障处理程序" class="headerlink" title="自定义故障处理程序"></a>自定义故障处理程序</h4><p>espresso允许开发者自定义FailureHandler用于错误处理，常见的做法有收集错误信息，截图或者传递额外的调试信息。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomFailureHandler</span> <span class="keyword">implements</span> <span class="title">FailureHandler</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> FailureHandler delegate;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CustomFailureHandler</span><span class="params">(Context targetContext)</span> </span>&#123;</span><br><span class="line">        delegate = <span class="keyword">new</span> DefaultFailureHandler(targetContext);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handle</span><span class="params">(Throwable error, Matcher&lt;View&gt; viewMatcher)</span></span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            delegate.handle(error, viewMatcher);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoMatchingViewException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> MySpecialException(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>需要自己定义Exception，并且在test中setFailureHandler();一般在setUp()中定义。</p>
<h4 id="定位非默认窗口"><a href="#定位非默认窗口" class="headerlink" title="定位非默认窗口"></a>定位非默认窗口</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">onView(withText(<span class="string">&quot;south china sea&quot;</span>))</span><br><span class="line">    .inRoot(withDecorView(not(is(getActivity().getWindow().getDecorView()))))</span><br><span class="line">    .perform(click());</span><br></pre></td></tr></table></figure>
<h4 id="在列表视图中匹配页眉和页脚"><a href="#在列表视图中匹配页眉和页脚" class="headerlink" title="在列表视图中匹配页眉和页脚"></a>在列表视图中匹配页眉和页脚</h4><p>想要匹配页眉和页脚，必须在listview.addFooter()或者listview.addHeader()中传递第二个参数。这个参数起到关联作用。例如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String FOOTER = <span class="string">&quot;FOOTER&quot;</span>;</span><br><span class="line">...</span><br><span class="line">View footerView = layoutInflater.inflate(R.layout.list_item, listView, <span class="keyword">false</span>);</span><br><span class="line">((TextView) footerView.findViewById(R.id.item_content)).setText(<span class="string">&quot;count:&quot;</span>);</span><br><span class="line">((TextView) footerView.findViewById(R.id.item_size)).setText(String.valueOf(data.size()));</span><br><span class="line">listView.addFooterView(footerView, FOOTER, <span class="keyword">true</span>);</span><br></pre></td></tr></table></figure>
<p>测试代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Matcher&lt;Object&gt; <span class="title">isFooter</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> allOf(is(instanceOf(String.class)), is(FOOTER));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testFooter</span><span class="params">()</span></span>&#123;</span><br><span class="line">    onData(isFooter()).perform(click());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="支持多进程"><a href="#支持多进程" class="headerlink" title="支持多进程"></a>支持多进程</h2><p>espresso允许跨进程测试，但是只是在Android 8.0及以上版本。所以请注意以下两点：</p>
<blockquote>
<blockquote>
</blockquote>
<p>应用最低版本为8.0，也就是API 26。<br>只能测试应用内的进程，无法测试外部进程。</p>
</blockquote>
<p>使用步骤</p>
<ol>
<li>在build.gradle中引用espresso-remote库<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">dependencies &#123;</span><br><span class="line">...</span><br><span class="line">androidTestImplementation &#x27;com.android.support.test.espresso:espresso-remote:3.0.2&#x27;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>需要在androidTest的Manifest文件中添加以下代码：<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;instrumentation android:name=&quot;android.support.test.runner.AndroidJUnitRunner&quot;</span><br><span class="line">android:targetPackage=&quot;android.support.mytestapp&quot;</span><br><span class="line">android:targetProcesses=&quot;xxx&quot;/&gt;</span><br><span class="line"></span><br><span class="line">&lt;meta-data</span><br><span class="line">android:name=&quot;remoteMethod&quot;</span><br><span class="line">android:value=&quot;android.support.test.espresso.remote.EspressoRemote#remoteInit&quot; /&gt;</span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="列表"><a href="#列表" class="headerlink" title="列表"></a>列表</h2><p>列表分为两种adapterview和recyclerview。</p>
<h3 id="adapterview列表项的交互"><a href="#adapterview列表项的交互" class="headerlink" title="adapterview列表项的交互"></a>adapterview列表项的交互</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//要点击包含“item: 50”的行</span></span><br><span class="line">onData(allOf(is(instanceOf(Map.class)), hasEntry(equalTo(<span class="string">&quot;STR&quot;</span>), is(<span class="string">&quot;item: 50&quot;</span>))));</span><br></pre></td></tr></table></figure>
<p>注意，Espresso会根据需要自动滚动列表。</p>
<p>我们分析上边的代码，首先is(instanceOf(Map.class))会将搜索范围缩小到map集合，然后hasEntry()会去匹配集合里key为“str”和value为”item: 50”的条目。</p>
<p>我们可以自定义matcher去match</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Matcher&lt;Object&gt; <span class="title">withItemContent</span><span class="params">(String expectedText)</span> </span>&#123;</span><br><span class="line">    checkNotNull(expectedText);</span><br><span class="line">    <span class="keyword">return</span> withItemContent(equalTo(expectedText));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Matcher&lt;Object&gt; <span class="title">withItemContent</span><span class="params">(Matcher&lt;Object&gt; itemTextMatcher)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> BoundedMatcher&lt;&gt;(Map.class)&#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">matchesSafely</span><span class="params">(Map map)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> hasEntry(equalTo(<span class="string">&quot;STR&quot;</span>), itemTextMatcher).matches(map);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">describeTo</span><span class="params">(Description description)</span> </span>&#123;</span><br><span class="line">            description.appendText(<span class="string">&quot;with item content: &quot;</span>);</span><br><span class="line">            itemTextMatcher.describeTo(description);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样就可以简单的调用了</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">onData(withItemContent(<span class="string">&quot;xxx&quot;</span>)).perform(click());</span><br></pre></td></tr></table></figure>
<h3 id="操作特定子view"><a href="#操作特定子view" class="headerlink" title="操作特定子view"></a>操作特定子view</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">onData(withItemContent(<span class="string">&quot;xxx&quot;</span>)).onChildView(withId(R.id.tst)).perform(click());</span><br></pre></td></tr></table></figure>
<h3 id="recyclerview的条目交互"><a href="#recyclerview的条目交互" class="headerlink" title="recyclerview的条目交互"></a>recyclerview的条目交互</h3><p>espresso-contrib库中包含一系列recyclerviewactions。</p>
<blockquote>
<blockquote>
</blockquote>
<p>scrollTo 滚动到匹配的view<br>scrollToHolder 滚动到匹配的viewholder<br>scrollToPosition 滚动到指定的position<br>actionOnHolderItem 在匹配到的view holder中进行操作<br>actionOnItem 在匹配到的item view上进行操作<br>actionOnItemAtPosition 在指定位置的view上进行操作</p>
</blockquote>
<p>实例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">scrollToItemBelowFold_checkItsText</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// First, scroll to the position that needs to be matched and click on it.</span></span><br><span class="line">    onView(ViewMatchers.withId(R.id.recyclerView))</span><br><span class="line">            .perform(RecyclerViewActions.actionOnItemAtPosition(ITEM_BELOW_THE_FOLD,</span><br><span class="line">            click()));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Match the text in an item below the fold and check that it&#x27;s displayed.</span></span><br><span class="line">    String itemElementText = mActivityRule.getActivity().getResources()</span><br><span class="line">            .getString(R.string.item_element_text)</span><br><span class="line">            + String.valueOf(ITEM_BELOW_THE_FOLD);</span><br><span class="line">    onView(withText(itemElementText)).check(matches(isDisplayed()));</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">itemInMiddleOfList_hasSpecialText</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// First, scroll to the view holder using the isInTheMiddle() matcher.</span></span><br><span class="line">    onView(ViewMatchers.withId(R.id.recyclerView))</span><br><span class="line">            .perform(RecyclerViewActions.scrollToHolder(isInTheMiddle()));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Check that the item has the special text.</span></span><br><span class="line">    String middleElementText =</span><br><span class="line">            mActivityRule.getActivity().getResources()</span><br><span class="line">            .getString(R.string.middle);</span><br><span class="line">    onView(withText(middleElementText)).check(matches(isDisplayed()));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="intent"><a href="#intent" class="headerlink" title="intent"></a>intent</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">assertThat(intent).hasAction(Intent.ACTION_VIEW);</span><br><span class="line">assertThat(intent).categories().containsExactly(Intent.CATEGORY_BROWSABLE);</span><br><span class="line">assertThat(intent).hasData(Uri.parse(<span class="string">&quot;www.google.com&quot;</span>));</span><br><span class="line">assertThat(intent).extras().containsKey(<span class="string">&quot;key1&quot;</span>);</span><br><span class="line">assertThat(intent).extras().string(<span class="string">&quot;key1&quot;</span>).isEqualTo(<span class="string">&quot;value1&quot;</span>);</span><br><span class="line">assertThat(intent).extras().containsKey(<span class="string">&quot;key2&quot;</span>);</span><br><span class="line">assertThat(intent).extras().string(<span class="string">&quot;key2&quot;</span>).isEqualTo(<span class="string">&quot;value2&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//断言已看到的给定 intent</span></span><br><span class="line">intented(toPackage(<span class="string">&quot;com.android.phone&quot;</span>));</span><br></pre></td></tr></table></figure>

<h2 id="插桩"><a href="#插桩" class="headerlink" title="插桩"></a>插桩</h2><p>当我们需要调用startActivityForResult()方法去启动照相机获取照片时，如果使用一般的方式，我们就需要手动去点击拍照，这样就不算自动化测试了。<br>Espresso-Intents 提供了intending()方法来解决这个问题，它可以为使用 startActivityForResult() 启动的 Activity 提供桩响应。简单来说就是，它不会去启动照相机，而是返回你自己定义的Intent。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">activityResult_DisplaysContactsPhoneNumber</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 1.构建要在启动特定 Activity 时返回的结</span></span><br><span class="line">    Intent resultData = <span class="keyword">new</span> Intent();</span><br><span class="line">    String phoneNumber = <span class="string">&quot;123-345-6789&quot;</span>;</span><br><span class="line">    resultData.putExtra(<span class="string">&quot;phone&quot;</span>, phoneNumber);</span><br><span class="line">    ActivityResult result =</span><br><span class="line">        <span class="keyword">new</span> ActivityResult(Activity.RESULT_OK, resultData);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2.指示 Espresso 提供桩结果对象来响应“contacts”intent 的所有调用</span></span><br><span class="line">    intending(toPackage(<span class="string">&quot;com.android.contacts&quot;</span>)).respondWith(result);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 启动activity，期待能够返回 phoneNumber</span></span><br><span class="line">    <span class="comment">// Launching activity expects phoneNumber to be returned and displayed.</span></span><br><span class="line">    onView(withId(R.id.pickButton)).perform(click());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3. 验证用于启动该 Activity 的操作是否产生了预期的桩结果，</span></span><br><span class="line">    <span class="comment">// 在本例中，该示例测试会检查当启动“contacts”Activity 时是否返回并显示了电话号码“123-345-6789”</span></span><br><span class="line">    onView(withId(R.id.phoneNumber)).check(matches(withText(phoneNumber)));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="https://github.com/android/testing-samples">这里可以查看很多官方的例子</a></p>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/android/" rel="tag"># android</a>
              <a href="/tags/%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95/" rel="tag"># 单元测试</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2020/10/19/android%E8%AE%BE%E5%A4%87id%E6%96%B9%E6%A1%88%E5%AF%B9%E6%AF%94/" rel="prev" title="android设备id方案对比">
      <i class="fa fa-chevron-left"></i> android设备id方案对比
    </a></div>
      <div class="post-nav-item">
    <a href="/2020/12/07/android%E8%87%AA%E5%AE%9A%E4%B9%89plugin%E4%B8%8EAMS%E5%AD%97%E8%8A%82%E7%A0%81%E4%BF%AE%E6%94%B9/" rel="next" title="android自定义plugin与ASM字节码修改">
      android自定义plugin与ASM字节码修改 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95"><span class="nav-number">1.</span> <span class="nav-text">单元测试</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9C%AC%E5%9C%B0%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95"><span class="nav-number">1.1.</span> <span class="nav-text">本地单元测试</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%8F%92%E6%A1%A9%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95"><span class="nav-number">1.2.</span> <span class="nav-text">插桩单元测试</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E9%9B%86%E6%88%90%E6%B5%8B%E8%AF%95"><span class="nav-number">2.</span> <span class="nav-text">集成测试</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Espresso"><span class="nav-number">2.1.</span> <span class="nav-text">Espresso</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#UI%E6%B5%8B%E8%AF%95"><span class="nav-number">3.</span> <span class="nav-text">UI测试</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#JUnit"><span class="nav-number">4.</span> <span class="nav-text">JUnit</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B8%B8%E7%94%A8%E6%B3%A8%E8%A7%A3"><span class="nav-number">4.1.</span> <span class="nav-text">常用注解</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B8%B8%E7%94%A8%E6%96%AD%E8%A8%80"><span class="nav-number">4.2.</span> <span class="nav-text">常用断言</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%A4%BA%E4%BE%8B"><span class="nav-number">4.3.</span> <span class="nav-text">示例</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Hamcrest"><span class="nav-number">4.4.</span> <span class="nav-text">Hamcrest</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Test-Runners"><span class="nav-number">4.5.</span> <span class="nav-text">Test Runners</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Suite"><span class="nav-number">4.6.</span> <span class="nav-text">Suite</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Rule"><span class="nav-number">4.7.</span> <span class="nav-text">Rule</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#TestName-Rule"><span class="nav-number">4.7.1.</span> <span class="nav-text">TestName Rule</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Timeout-Rule"><span class="nav-number">4.7.2.</span> <span class="nav-text">Timeout Rule</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ExpectedException-Rules"><span class="nav-number">4.7.3.</span> <span class="nav-text">ExpectedException Rules</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#TemporaryFolder-Rule"><span class="nav-number">4.7.4.</span> <span class="nav-text">TemporaryFolder Rule</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ExternalResource-Rules"><span class="nav-number">4.7.5.</span> <span class="nav-text">ExternalResource Rules</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Custom-Rule"><span class="nav-number">4.7.6.</span> <span class="nav-text">Custom Rule</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Mockito"><span class="nav-number">5.</span> <span class="nav-text">Mockito</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%AA%8C%E8%AF%81"><span class="nav-number">5.1.</span> <span class="nav-text">验证</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Stubbing"><span class="nav-number">5.1.1.</span> <span class="nav-text">Stubbing</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Argument-Matchers"><span class="nav-number">5.1.2.</span> <span class="nav-text">Argument Matchers</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%AA%8C%E8%AF%81%E8%B0%83%E7%94%A8%E6%AC%A1%E6%95%B0"><span class="nav-number">5.1.3.</span> <span class="nav-text">验证调用次数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#spy"><span class="nav-number">5.1.4.</span> <span class="nav-text">spy</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Robolectric"><span class="nav-number">6.</span> <span class="nav-text">Robolectric</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B5%8B%E8%AF%95%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F"><span class="nav-number">6.1.</span> <span class="nav-text">测试生命周期</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B5%8B%E8%AF%95Toast"><span class="nav-number">6.2.</span> <span class="nav-text">测试Toast</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B5%8B%E8%AF%95Dialog"><span class="nav-number">6.3.</span> <span class="nav-text">测试Dialog</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B5%8B%E8%AF%95%E8%B5%84%E6%BA%90%E6%96%87%E4%BB%B6"><span class="nav-number">6.4.</span> <span class="nav-text">测试资源文件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B5%8B%E8%AF%95Fragment"><span class="nav-number">6.5.</span> <span class="nav-text">测试Fragment</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%BC%82%E6%AD%A5%E4%BB%A3%E7%A0%81%E6%B5%8B%E8%AF%95"><span class="nav-number">7.</span> <span class="nav-text">异步代码测试</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Espresso-1"><span class="nav-number">8.</span> <span class="nav-text">Espresso</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BE%9D%E8%B5%96%E5%BA%93"><span class="nav-number">8.1.</span> <span class="nav-text">依赖库</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9F%BA%E7%A1%80%E9%85%8D%E7%BD%AE"><span class="nav-number">8.2.</span> <span class="nav-text">基础配置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#API%E7%BB%84%E4%BB%B6"><span class="nav-number">8.3.</span> <span class="nav-text">API组件</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9F%A5%E6%89%BE%E8%A7%86%E5%9B%BE"><span class="nav-number">8.3.1.</span> <span class="nav-text">查找视图</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%93%8D%E4%BD%9C%E8%A7%86%E5%9B%BE"><span class="nav-number">8.3.2.</span> <span class="nav-text">操作视图</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A3%80%E6%9F%A5%E6%96%AD%E8%A8%80"><span class="nav-number">8.3.3.</span> <span class="nav-text">检查断言</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E6%96%AD%E8%A8%80"><span class="nav-number">8.3.4.</span> <span class="nav-text">自定义断言</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E6%95%85%E9%9A%9C%E5%A4%84%E7%90%86%E7%A8%8B%E5%BA%8F"><span class="nav-number">8.3.4.1.</span> <span class="nav-text">自定义故障处理程序</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%9A%E4%BD%8D%E9%9D%9E%E9%BB%98%E8%AE%A4%E7%AA%97%E5%8F%A3"><span class="nav-number">8.3.4.2.</span> <span class="nav-text">定位非默认窗口</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9C%A8%E5%88%97%E8%A1%A8%E8%A7%86%E5%9B%BE%E4%B8%AD%E5%8C%B9%E9%85%8D%E9%A1%B5%E7%9C%89%E5%92%8C%E9%A1%B5%E8%84%9A"><span class="nav-number">8.3.4.3.</span> <span class="nav-text">在列表视图中匹配页眉和页脚</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%94%AF%E6%8C%81%E5%A4%9A%E8%BF%9B%E7%A8%8B"><span class="nav-number">8.4.</span> <span class="nav-text">支持多进程</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%97%E8%A1%A8"><span class="nav-number">8.5.</span> <span class="nav-text">列表</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#adapterview%E5%88%97%E8%A1%A8%E9%A1%B9%E7%9A%84%E4%BA%A4%E4%BA%92"><span class="nav-number">8.5.1.</span> <span class="nav-text">adapterview列表项的交互</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%93%8D%E4%BD%9C%E7%89%B9%E5%AE%9A%E5%AD%90view"><span class="nav-number">8.5.2.</span> <span class="nav-text">操作特定子view</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#recyclerview%E7%9A%84%E6%9D%A1%E7%9B%AE%E4%BA%A4%E4%BA%92"><span class="nav-number">8.5.3.</span> <span class="nav-text">recyclerview的条目交互</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#intent"><span class="nav-number">8.6.</span> <span class="nav-text">intent</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%8F%92%E6%A1%A9"><span class="nav-number">8.7.</span> <span class="nav-text">插桩</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="pacoblack"
      src="/images/avatar1.jpeg">
  <p class="site-author-name" itemprop="name">pacoblack</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">56</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">20</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">19</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/pacoblack" title="GitHub → https://github.com/pacoblack" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:pacoson.wang@gmail.com" title="E-Mail → mailto:pacoson.wang@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



      </div>
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">pacoblack</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  
  <script color='0,0,0' opacity='0.5' zIndex='-1' count='99' src="//cdn.bootcss.com/canvas-nest.js/1.0.0/canvas-nest.min.js"></script>
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

  
  <script type="text/javascript" src="//cdn.bootcss.com/canvas-nest.js/1.0.0/canvas-nest.min.js"></script>
  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer@1.10/dist/APlayer.min.css" class="aplayer-style-marker">
  <script src="https://cdn.jsdelivr.net/npm/aplayer@1.10/dist/APlayer.min.js" class="aplayer-script-marker"></script>
  <script src="https://cdn.jsdelivr.net/npm/meting@1.2/dist/Meting.min.js" class="meting-script-marker"></script>
  <div id="aplayer-AXqIDvNX"
      class="aplayer aplayer-tag-marker meting-tag-marker aplayer-fixed"
      data-id="71075946"
      data-server="netease"
      data-type="playlist"
      data-mode="circulation"
      data-autoplay="false"
      data-mutex="true"
      data-listmaxheight="340px"
      data-preload="auto"
      data-fixed="true"
      data-lrctype="0"
      data-theme="#555"></div>
<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"log":false,"model":{"jsonPath":"/live2dw/assets/Epsilon2.1.model.json"},"display":{"position":"right","width":150,"height":300},"mobile":{"show":true},"react":{"opacity":0.7}});</script></body>
</html>
